module.exports=[58190,a=>{"use strict";a.s(["default",()=>aa],58190);var b=a.i(87924),c=a.i(72131),d=a.i(75003),e=a.i(50944),f=a.i(22677),g=a.i(18459),h=a.i(15720);let i={Musk:[{type:"Musk",name:"Cloud",color:"#F5F5DC"},{type:"Musk",name:"Cloud",color:"#FFFDD0"},{type:"Musk",name:"Cloud",color:"#F5DEB3"}],Aromatic:[{type:"Aromatic",name:"Herb",color:"#9CAF88"},{type:"Aromatic",name:"Lavender",color:"#B19CD9"}],Woody:[{type:"Woody",name:"Wood",color:"#8B4513"},{type:"Woody",name:"Wood",color:"#A0826D"},{type:"Woody",name:"Wood",color:"#704214"}],Citrus:[{type:"Citrus",name:"Orange",color:"#FFD700"},{type:"Citrus",name:"Lemon",color:"#FFA500"},{type:"Citrus",name:"Lime",color:"#32CD32"}],Green:[{type:"Green",name:"Sprout",color:"#00FF00"},{type:"Green",name:"Grass",color:"#50C878"}],Marine:[{type:"Marine",name:"Wave",color:"#87CEEB"},{type:"Marine",name:"Shell",color:"#00CED1"}],Floral:[{type:"Floral",name:"Rose",color:"#FF69B4"},{type:"Floral",name:"Rose",color:"#FF7F50"},{type:"Floral",name:"Rose",color:"#8B008B"}]},j=[{id:"calm-1",name:"Calm Breeze",color:"#E6F3FF",song:{title:"Calm Breeze",duration:182},scent:i.Marine[0]},{id:"calm-2",name:"Calm Breeze",color:"#D4E6F1",song:{title:"Ocean Waves",duration:195},scent:i.Marine[1]},{id:"calm-3",name:"Calm Breeze",color:"#AED6F1",song:{title:"Gentle Rain",duration:210},scent:i.Green[0]},{id:"focus-1",name:"Deep Focus",color:"#F5F5DC",song:{title:"Deep Focus",duration:240},scent:i.Musk[0]},{id:"focus-2",name:"Deep Focus",color:"#FFFDD0",song:{title:"Concentration",duration:220},scent:i.Musk[1]},{id:"focus-3",name:"Deep Focus",color:"#F5DEB3",song:{title:"Study Time",duration:200},scent:i.Musk[2]},{id:"energy-1",name:"Morning Energy",color:"#FFD700",song:{title:"Sunrise",duration:180},scent:i.Citrus[0]},{id:"energy-2",name:"Morning Energy",color:"#FFA500",song:{title:"Vitality",duration:190},scent:i.Citrus[1]},{id:"energy-3",name:"Morning Energy",color:"#32CD32",song:{title:"Fresh Start",duration:175},scent:i.Citrus[2]},{id:"relax-1",name:"Evening Relax",color:"#9CAF88",song:{title:"Soft Evening",duration:195},scent:i.Aromatic[0]},{id:"relax-2",name:"Evening Relax",color:"#B19CD9",song:{title:"Peaceful Night",duration:210},scent:i.Aromatic[1]},{id:"relax-3",name:"Evening Relax",color:"#8B4513",song:{title:"Cozy Fireplace",duration:225},scent:i.Woody[0]},{id:"romantic-1",name:"Romantic Night",color:"#FF69B4",song:{title:"Love Song",duration:200},scent:i.Floral[0]},{id:"romantic-2",name:"Romantic Night",color:"#FF7F50",song:{title:"Intimate",duration:185},scent:i.Floral[1]},{id:"romantic-3",name:"Romantic Night",color:"#8B008B",song:{title:"Passion",duration:195},scent:i.Floral[2]}];var k=a.i(33496),l=a.i(43517),m=a.i(68114);function n(){let a=Date.now(),b=Math.floor(a/6e5)%j.length,c=j[b],d=Array.from({length:10},(c,d)=>{let e=(b+d+Math.floor(3*Math.random()))%j.length,f=j[e];return{timestamp:a+18e4*d,duration:18e4,mood:{id:f.id,name:f.name,color:f.color,music:{genre:"newage",title:f.song.title},scent:{type:f.scent.type,name:f.scent.name},lighting:{color:f.color,rgb:(0,m.hexToRgb)(f.color)}}}});return{streamId:`mock-stream-${Date.now()}`,currentMood:{id:c.id,name:c.name,color:c.color,music:{genre:"newage",title:c.song.title},scent:{type:c.scent.type,name:c.scent.name},lighting:{color:c.color,rgb:(0,m.hexToRgb)(c.color)}},segments:d,createdAt:a,userDataCount:0}}function o(){let[a,b]=(0,c.useState)(null),[d,e]=(0,c.useState)(!0),[f,g]=(0,c.useState)(0),h=(0,c.useCallback)(async()=>{e(!0);try{let a=await fetch("/api/moods/current",{credentials:"include"});if(401===a.status){window.location.href="/login";return}if(!a.ok)throw Error("Failed to fetch mood stream");let c=await a.json();if(!c.currentMood||!c.moodStream||!Array.isArray(c.moodStream)){console.warn("[useMoodStream] Invalid response format or no mood stream available");try{let a=n();b(a),g(0)}catch(a){console.error("[useMoodStream] Error loading mock data:",a),b(null),g(0)}return}let d=`stream-${Date.now()}`;b({streamId:d,currentMood:c.currentMood,segments:c.moodStream,createdAt:Date.now(),userDataCount:c.userDataCount||0});let e=Date.now(),f=c.moodStream.findIndex(a=>a.timestamp<=e&&e<a.timestamp+a.duration);g(f>=0?f:0)}catch(a){console.error("Error fetching mood stream:",a);try{let a=n();b(a),g(0)}catch(a){console.error("Error loading mock data:",a),b(null)}}finally{e(!1)}},[]),i=(0,c.useCallback)(async()=>{e(!0);try{let a=await fetch("/api/moods/current/refresh",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include"});if(401===a.status){window.location.href="/login";return}if(!a.ok)throw Error("Failed to refresh mood stream");let c=await a.json();if(!c.currentMood||!c.moodStream||!Array.isArray(c.moodStream)){console.warn("[useMoodStream] Invalid refresh response, using mock data");let a=n();b(a),g(0);return}b({streamId:c.streamId||`stream-${Date.now()}`,currentMood:c.currentMood,segments:c.moodStream,createdAt:Date.now(),userDataCount:c.userDataCount||0}),g(0)}catch(a){console.error("Error refreshing mood stream:",a);try{let a=n();b(a),g(0)}catch(a){console.error("Error loading mock data:",a)}}finally{e(!1)}},[]);(0,c.useEffect)(()=>{h()},[h]);let j=a?.segments[f]||null;return{moodStream:a,currentSegment:j,currentSegmentIndex:f,isLoading:d,refreshMoodStream:i,setCurrentSegmentIndex:g}}var p=a.i(70106);let q=(0,p.default)("refresh-ccw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]),r=(0,p.default)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]),s=(0,p.default)("heart",[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]]);function t({onComplete:a,x:d,y:e}){let[f,g]=(0,c.useState)(!0);return((0,c.useEffect)(()=>{let b=setTimeout(()=>{g(!1),setTimeout(()=>{a()},300)},1200);return()=>clearTimeout(b)},[a]),f)?(0,b.jsxs)("div",{className:"fixed pointer-events-none z-50",style:{left:`${d}px`,top:`${e}px`,transform:"translate(-50%, -50%)"},children:[(0,b.jsx)("div",{className:"absolute animate-heart-float",style:{animationDelay:"0ms",transform:"translate(-20px, 0)"},children:(0,b.jsx)(s,{size:28,className:"text-red-500 fill-red-500"})}),(0,b.jsx)("div",{className:"absolute animate-heart-float",style:{animationDelay:"100ms",transform:"translate(20px, 0)"},children:(0,b.jsx)(s,{size:32,className:"text-red-500 fill-red-500"})})]}):null}function u({mood:a,isSaved:d,onSaveToggle:e,onRefresh:f,llmSource:g,onPreferenceClick:h,maxReached:i=!1}){let[j,k]=(0,c.useState)(!1),[l,m]=(0,c.useState)(null),[n,o]=(0,c.useState)(0);return(0,b.jsxs)(b.Fragment,{children:[j&&l&&(0,b.jsx)(t,{x:l.x,y:l.y,onComplete:()=>{k(!1),m(null)}}),(0,b.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,b.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,b.jsx)("div",{className:"text-base font-semibold text-gray-800 cursor-pointer select-none",onDoubleClick:a=>{let b=Date.now();b-n<300?(!i&&h&&(m({x:a.clientX,y:a.clientY}),k(!0),h()),o(0)):o(b)},title:i?"최대 선호도 카운트(3)에 도달했습니다":"더블클릭하여 선호도 표시 (최대 3번)",children:a.name}),g&&(0,b.jsxs)("span",{className:"text-[10px] text-gray-500",children:["LLM: ",g]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("button",{onClick:a=>{a.stopPropagation(),e()},className:`p-1.5 rounded-full bg-white/40 backdrop-blur hover:bg-white/60 transition ${d?"text-yellow-500":"text-gray-400"}`,title:d?"저장된 무드 (클릭하여 제거)":"무드 저장하기",children:(0,b.jsx)(r,{size:16,fill:d?"currentColor":"none",strokeWidth:1.5*!d})}),(0,b.jsx)("button",{onClick:f,className:"p-1.5 rounded-full bg-white/40 backdrop-blur hover:bg-white/60 transition text-gray-800",title:"Refresh mood (same mood cluster)",children:(0,b.jsx)(q,{size:16})})]})]})]})}var v=a.i(42343);function w(a){return(0,v.GenIcon)({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 10m0 2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v7a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2z"},child:[]},{tag:"path",attr:{d:"M6 10v-4a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v4"},child:[]},{tag:"path",attr:{d:"M15 7h.01"},child:[]},{tag:"path",attr:{d:"M18 9h.01"},child:[]},{tag:"path",attr:{d:"M18 5h.01"},child:[]},{tag:"path",attr:{d:"M21 3h.01"},child:[]},{tag:"path",attr:{d:"M21 7h.01"},child:[]},{tag:"path",attr:{d:"M21 11h.01"},child:[]},{tag:"path",attr:{d:"M10 7h1"},child:[]}]})(a)}function x({mood:a,onScentClick:c,moodColor:d}){let e=d||a.color;return(0,b.jsxs)("div",{className:"flex items-center justify-end gap-1.5 mb-2",children:[(0,b.jsx)("span",{className:"text-sm text-gray-700",children:a.scent.name}),(0,b.jsx)("button",{onClick:a=>{a.stopPropagation(),c()},className:"w-7 h-7 rounded-full shadow flex items-center justify-center hover:scale-105 transition cursor-pointer",style:{backgroundColor:(0,m.hexToRgba)(e,.85)},title:"Change scent",children:(0,b.jsx)(w,{size:16,style:{color:"#ffffff"}})})]})}function y({mood:a,onAlbumClick:c,musicSelection:d}){return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"flex justify-center mb-2",children:(0,b.jsx)("button",{onClick:c,className:"w-20 h-20 rounded-full bg-white shadow-md border flex items-center justify-center text-xs font-medium hover:scale-105 transition cursor-pointer",children:"Album Art"})}),(0,b.jsx)("p",{className:"text-center text-xs font-medium mb-1.5 text-gray-800",children:d||a.song.title})]})}let z=(0,p.default)("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]),A=(0,p.default)("pause",[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]]),B=(0,p.default)("skip-back",[["path",{d:"M17.971 4.285A2 2 0 0 1 21 6v12a2 2 0 0 1-3.029 1.715l-9.997-5.998a2 2 0 0 1-.003-3.432z",key:"15892j"}],["path",{d:"M3 20V4",key:"1ptbpl"}]]),C=(0,p.default)("skip-forward",[["path",{d:"M21 4v16",key:"7j8fe9"}],["path",{d:"M6.029 4.285A2 2 0 0 0 3 6v12a2 2 0 0 0 3.029 1.715l9.997-5.998a2 2 0 0 0 .003-3.432z",key:"zs4d6"}]]);function D(a){let b=Math.floor(a/60),c=Math.floor(a%60);return`${b}:${c.toString().padStart(2,"0")}`}function E({mood:a,progress:c,playing:d,onPlayToggle:e,onPrevious:f,onNext:g}){return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"w-full flex items-center mb-2",children:[(0,b.jsx)("span",{className:"text-xs mr-2 text-gray-800",children:D(c)}),(0,b.jsx)("div",{className:"flex-1 h-1 bg-white/50 rounded",children:(0,b.jsx)("div",{className:"h-1 bg-black rounded",style:{width:`${c/a.song.duration*100}%`}})}),(0,b.jsx)("span",{className:"text-xs ml-2 text-gray-800",children:D(a.song.duration)})]}),(0,b.jsxs)("div",{className:"flex justify-center items-center gap-4 mb-3",children:[(0,b.jsx)("button",{onClick:a=>{a.stopPropagation(),f()},className:"p-1.5 text-gray-800",title:"Previous song",children:(0,b.jsx)(B,{size:18})}),(0,b.jsx)("button",{className:"p-2 bg-white rounded-full shadow text-gray-800",onClick:a=>{a.stopPropagation(),e()},title:d?"Pause":"Play",children:d?(0,b.jsx)(A,{size:16}):(0,b.jsx)(z,{size:16})}),(0,b.jsx)("button",{onClick:a=>{a.stopPropagation(),g()},className:"p-1.5 text-gray-800",title:"Next song",children:(0,b.jsx)(C,{size:18})})]})]})}function F({mood:a,currentIndex:c,totalSegments:d,onSegmentSelect:e,moodColorCurrent:f,moodColorPast:g}){let h=f||a.color,i=g||(0,m.blendWithWhite)(h,.9),j=(0,m.blendWithWhite)(h,.97),k=d>0?d:10,l=c>=0?c<k?c:k-1:0,n=Array.from({length:k},(a,b)=>b);return(0,b.jsxs)("div",{className:"mb-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,b.jsx)("span",{className:"text-xs text-gray-600",children:"Mood Duration"}),(0,b.jsxs)("span",{className:"text-xs font-medium text-gray-800",children:[l+1,"/",k]})]}),(0,b.jsx)("div",{className:"w-full flex gap-[2px]",children:n.map(a=>{let c=a===l,d=a<l,f=c?h:d?i:j;return(0,b.jsx)("div",{className:"flex-1 h-2 rounded-full transition-all cursor-pointer hover:opacity-70",onClick:b=>{b.stopPropagation(),e?.(a)},style:{backgroundColor:f,opacity:c?1:d?.7:.35},title:`${a+1}번째 구간으로 이동`},a)})})]})}function G({mood:a,onMoodChange:e,onScentChange:f,onSongChange:g,backgroundParams:i,onRefreshRequest:n}){let{moodStream:p,currentSegment:q,currentSegmentIndex:r,isLoading:s,refreshMoodStream:v,setCurrentSegmentIndex:w}=o(),{isLoading:z,playing:A,setPlaying:B,progress:C,isSaved:D,setIsSaved:G,handleScentClick:H,handlePreviousSong:I,handleNextSong:J,handleRefreshClick:K,handleAlbumClick:L,handlePreferenceClick:M,preferenceCount:N,maxReached:O}=function({mood:a,onMoodChange:b,onScentChange:e,onSongChange:f,currentSegment:g}){let{data:h}=(0,d.useSession)(),i=h?.user?.email===l.ADMIN_EMAIL,[m,n]=(0,c.useState)(!0),[o,p]=(0,c.useState)(!0),[q]=(0,c.useState)(20),[r,s]=(0,c.useState)(!1),[t]=(0,c.useState)(30),[u,v]=(0,c.useState)(0),[w,x]=(0,c.useState)(!1);(0,c.useEffect)(()=>{s(!1)},[a.id]),(0,c.useEffect)(()=>{let a=setTimeout(()=>{n(!1)},500);return()=>clearTimeout(a)},[]),(0,c.useEffect)(()=>{(async()=>{try{let b=await fetch("/api/moods/preference");if(b.ok){let c=await b.json(),d=c.moodPreferences?.[a.id]||0;v(d),x(d>=3)}}catch(a){console.error("Error fetching preference count:",a)}})()},[a.id]);let y=a=>j.filter(b=>b.name===a),z=async()=>{if(r)try{if(i){let b=(0,k.getSavedMoods)().find(b=>b.moodId===a.id);b&&((0,k.deleteSavedMood)(b.id),s(!1))}else{let b=await fetch("/api/moods/saved",{credentials:"include"});if(b.ok){let c=await b.json(),d=c.savedMoods?.find(b=>b.moodId===a.id);d&&(await fetch(`/api/moods/saved/${d.id}`,{method:"DELETE",credentials:"include"})).ok&&s(!1)}}}catch(a){console.error("Error removing saved mood:",a)}else try{let b=g?.mood?.music?.genre||"newage",c={id:`saved-${Date.now()}`,moodId:a.id,moodName:a.name,moodColor:a.color,music:{genre:b,title:a.song.title},scent:{type:a.scent.type,name:a.scent.name},preferenceCount:u,savedAt:Date.now()};i&&((0,k.saveMood)(c),s(!0)),(await fetch("/api/moods/saved",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({moodId:c.moodId,moodName:c.moodName,moodColor:c.moodColor,music:c.music,scent:c.scent,preferenceCount:c.preferenceCount})})).ok&&s(!0)}catch(a){console.error("Error saving mood:",a)}};return{isLoading:m,playing:o,setPlaying:p,progress:q,isSaved:r,setIsSaved:z,moodDuration:t,handleScentClick:async()=>{if(g)try{let b=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"scent",segment:g})});if(b.ok){let c=(await b.json()).scentType||a.scent.type,d={...a,scent:{...a.scent,type:c}};e(d);return}}catch(a){console.error("Error updating scent via LLM:",a)}let b=y(a.name);if(b.length<=1)return void console.warn("No alternative moods with same name found");let c=b.findIndex(b=>b.id===a.id);if(-1===c)return void e(b[0]);let d=(c+1)%b.length,f=b[d];if(f.scent.name!==a.scent.name||f.scent.type!==a.scent.type)e(f);else{let c=(d+1)%b.length,f=b[c];(f.scent.name!==a.scent.name||f.scent.type!==a.scent.type)&&e(f)}},handlePreviousSong:()=>{let b=y(a.name),c=b.findIndex(b=>b.id===a.id),d=0===c?b.length-1:c-1;f(b[d])},handleNextSong:()=>{let b=y(a.name),c=(b.findIndex(b=>b.id===a.id)+1)%b.length;f(b[c])},handleRefreshClick:()=>{let c=y(a.name);if(c.length>1){let d=c.filter(b=>b.id!==a.id);b(d[Math.floor(Math.random()*d.length)])}else b(j[Math.floor(Math.random()*j.length)])},handleAlbumClick:async()=>{if(g)try{let b=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"music",segment:g})});if(b.ok){let c=(await b.json()).musicSelection||a.song.title,d={...a,song:{...a.song,title:c}};f(d);return}}catch(a){console.error("Error updating music via LLM:",a)}b(j[Math.floor(Math.random()*j.length)])},handlePreferenceClick:async()=>{if(!w&&!(u>=3))try{let b=g?.mood?.music?.genre||"newage",c=a.scent.type,d=await fetch("/api/moods/preference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({moodId:a.id,moodName:a.name,musicGenre:b,scentType:c,moodColor:a.color})});if(!d.ok){let a=await d.json();throw a.maxReached&&(x(!0),v(3)),Error(a.error||"Failed to update preference")}let e=await d.json();v(e.currentCount),x(e.maxReached)}catch(a){console.error("Error updating preference:",a)}},preferenceCount:u,maxReached:w}}({mood:a,onMoodChange:e,onScentChange:f,onSongChange:g,currentSegment:q}),{baseColor:P,accentColor:Q,displayAlias:R,llmSource:S}=function({mood:a,backgroundParams:b}){return(0,c.useMemo)(()=>{let c=b?.moodColor||a.color,d=(0,m.blendWithWhite)(c,.9);return{baseColor:c,accentColor:d,displayAlias:b?.moodAlias||a.name,llmSource:b?.source}},[a.color,a.name,b?.moodColor,b?.moodAlias,b?.source])}({mood:a,backgroundParams:i}),{heartAnimation:T,handleDashboardDoubleClick:U,clearHeartAnimation:V}=function(){let[a,b]=(0,c.useState)(null),[d,e]=(0,c.useState)(0);return{heartAnimation:a,handleDashboardDoubleClick:(0,c.useCallback)(a=>{let c=Date.now();c-d<300?(b({x:a.clientX,y:a.clientY}),e(0)):e(c)},[d]),clearHeartAnimation:(0,c.useCallback)(()=>{b(null)},[])}}(),{handleSegmentSelect:W}=function({moodStream:a,currentMood:b,setCurrentSegmentIndex:d,onMoodChange:e}){return{handleSegmentSelect:(0,c.useCallback)(c=>{if(!a||!a.segments||0===a.segments.length)return void console.warn("Mood stream not available for segment selection");let f=Math.max(0,Math.min(c,a.segments.length-1));d(f);let g=a.segments[f];g?.mood?e(function(a,b){let c=a.scent?.type||b.scent.type;return{id:a.id||b.id,name:a.name||b.name,color:a.color||b.color,song:{title:a.music?.title||b.song.title,duration:b.song.duration},scent:{type:c,name:a.scent?.name||b.scent.name,color:b.scent.color}}}(g.mood,b)):console.warn("Target segment mood not found",{clampedIndex:f,target:g})},[a,b,d,e])}}({moodStream:p,currentMood:a,setCurrentSegmentIndex:w,onMoodChange:e}),X=(0,c.useCallback)(()=>{v(),K(),n?.()},[v,K,n]);return z||s?(0,b.jsx)(h.MoodDashboardSkeleton,{}):(0,b.jsxs)(b.Fragment,{children:[T&&(0,b.jsx)(t,{x:T.x,y:T.y,onComplete:V}),(0,b.jsxs)("div",{className:"rounded-xl px-3 mb-1 w-full backdrop-blur-sm border",style:{backgroundColor:(0,m.hexToRgba)(P,.25),borderColor:Q,paddingTop:"11px",paddingBottom:"8px"},onDoubleClick:U,children:[(0,b.jsx)(u,{mood:{...a,name:R},isSaved:D,onSaveToggle:G,onRefresh:X,llmSource:S,onPreferenceClick:M,preferenceCount:N,maxReached:O}),(0,b.jsx)(x,{mood:a,onScentClick:H,moodColor:Q}),(0,b.jsx)(y,{mood:a,onAlbumClick:L,musicSelection:i?.musicSelection}),(0,b.jsx)(E,{mood:a,progress:C,playing:A,onPlayToggle:()=>B(!A),onPrevious:I,onNext:J}),(0,b.jsx)(F,{mood:a,currentIndex:r,totalSegments:p?.segments.length||10,onSegmentSelect:W,moodColorCurrent:P,moodColorPast:Q})]})]})}var H=a.i(71682);function I({device:a,currentMood:c,onClick:d}){var e,f;let g=a.power?c?(0,m.blendWithWhite)(c.color,.9):"rgb(255, 255, 255)":"rgba(200, 200, 200, 0.8)";return(0,b.jsxs)("div",{onClick:d,className:`h-[100px] p-3 rounded-xl shadow-sm border cursor-pointer transition-all flex flex-col backdrop-blur-sm ${"manager"===a.type?"justify-between":"justify-start gap-2"}
        ${a.power?"":"opacity-60"}
      `,style:{backgroundColor:a.power?`${g}CC`:"rgba(200, 200, 200, 0.8)"},children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"text-base",children:"manager"===(e=a.type)?(0,b.jsx)(H.FaPalette,{className:"text-purple-500"}):"light"===e?(0,b.jsx)(H.FaLightbulb,{className:"text-yellow-500"}):"scent"===e?(0,b.jsx)(H.FaSprayCan,{className:"text-green-500"}):"speaker"===e?(0,b.jsx)(H.FaVolumeUp,{className:"text-blue-500"}):(0,b.jsx)(H.FaCog,{className:"text-gray-500"})}),(0,b.jsx)("div",{className:"text-xs font-medium flex-1 truncate",children:a.name}),(0,b.jsx)("div",{className:"text-sm",children:(f=a.battery,a.power?f>=70?(0,b.jsx)(H.FaBatteryFull,{className:"text-green-500"}):f>=30?(0,b.jsx)(H.FaBatteryHalf,{className:"text-yellow-500"}):(0,b.jsx)(H.FaBatteryEmpty,{className:"text-red-500"}):(0,b.jsx)(H.FaBatteryFull,{className:"text-gray-400"}))})]}),(0,b.jsx)("div",{className:"text-xs text-gray-600",children:function(a){if(!a.power)return"Power Off";switch(a.type){case"manager":let c=a.output.brightness?`Light: ${a.output.brightness}%`:"Light: -",d=a.output.scentType?`Scent: ${a.output.scentType}`:"Scent: -",e=a.output.nowPlaying?`Music: ${a.output.nowPlaying}`:"Music: -";return(0,b.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,b.jsx)("div",{children:c}),(0,b.jsx)("div",{children:d}),(0,b.jsx)("div",{children:e})]});case"light":return a.output.brightness?`Light Status: ${a.output.brightness}%`:"Light Status: -";case"scent":return a.output.scentType?`Scent Status: ${a.output.scentType} (Level ${a.output.scentLevel||0})`:"Scent Status: -";case"speaker":return a.output.nowPlaying?`Music Status: ${a.output.nowPlaying}`:"Music Status: -";default:return""}}(a)})]},`device-small-${a.id}-${a.power}`)}let J=(0,p.default)("power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);function K({name:a,onUpdate:d}){let[e,f]=(0,c.useState)(!1),[g,h]=(0,c.useState)(a),i=()=>{""!==g.trim()&&g!==a?d(g.trim()):h(a),f(!1)};return e?(0,b.jsx)("input",{type:"text",value:g,onChange:a=>h(a.target.value),onBlur:i,onKeyDown:b=>{"Enter"===b.key?i():"Escape"===b.key&&(h(a),f(!1))},onClick:a=>a.stopPropagation(),className:"text-lg font-semibold bg-white border border-gray-300 rounded px-2 py-1 outline-none focus:ring-2 focus:ring-black",autoFocus:!0}):(0,b.jsx)("div",{className:"text-lg font-semibold cursor-text hover:underline",onClick:a=>{a.stopPropagation(),f(!0)},title:"Click to edit name",children:a})}let L=(0,p.default)("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);function M({device:a,currentMood:c,lightColor:d,lightBrightness:e,scentLevel:f,onUpdateLightColor:g,onUpdateLightBrightness:h,onUpdateScentLevel:i}){if(!a.power)return null;switch(a.type){case"light":return(0,b.jsx)("div",{className:"space-y-2",onClick:a=>a.stopPropagation(),children:(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Brightness: ",e,"%"]}),(0,b.jsx)("input",{type:"range",min:0,max:100,value:e,onChange:a=>{let b=Number(a.target.value);h?.(b)},className:"w-full",style:{accentColor:c?.color||"#FFD700"}})]})});case"scent":return(0,b.jsx)("div",{className:"space-y-2",onClick:a=>a.stopPropagation(),children:(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Scent Level: ",f,"/10"]}),(0,b.jsx)("input",{type:"range",min:1,max:10,value:f,onChange:a=>{let b=Number(a.target.value);i?.(b)},className:"w-full",style:{accentColor:c?.color||"#9CAF88"}})]})});case"speaker":return(0,b.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,b.jsxs)("div",{children:["Current: ",a.output.nowPlaying||"-"]}),(0,b.jsxs)("div",{className:"mt-1 flex items-center gap-1 text-gray-500",children:[(0,b.jsx)("span",{children:"Next song"}),(0,b.jsx)(L,{size:12})]})]});case"manager":return(0,b.jsxs)("div",{className:"space-y-2",onClick:a=>a.stopPropagation(),children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"text-xs text-gray-600 mb-1 block",children:"Light Color"}),(0,b.jsx)("input",{type:"color",value:d,onChange:a=>{let b=a.target.value;g?.(b)},className:"w-full h-8 rounded cursor-pointer"})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Light Brightness: ",e,"%"]}),(0,b.jsx)("input",{type:"range",min:0,max:100,value:e,onChange:a=>{let b=Number(a.target.value);h?.(b)},className:"w-full",style:{accentColor:d}})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Scent Level: ",f,"/10"]}),(0,b.jsx)("input",{type:"range",min:1,max:10,value:f,onChange:a=>{let b=Number(a.target.value);i?.(b)},className:"w-full",style:{accentColor:c?.color||"#9CAF88"}})]}),(0,b.jsxs)("div",{className:"text-xs text-gray-600 pt-2 border-t border-gray-200",children:[(0,b.jsxs)("div",{children:["Current: ",a.output.nowPlaying||"-"]}),(0,b.jsxs)("div",{className:"mt-1 flex items-center gap-1 text-gray-500",children:[(0,b.jsx)("span",{children:"Next song"}),(0,b.jsx)(L,{size:12})]})]})]});default:return null}}function N({device:a,currentMood:d,onClose:e,onDelete:f,onTogglePower:g,onUpdateName:h,onUpdateLightColor:i,onUpdateLightBrightness:j,onUpdateScentLevel:k}){var l;let{lightColor:n,setLightColor:o,lightBrightness:p,setLightBrightness:q,scentLevel:r,setScentLevel:s,backgroundColor:t}=function({device:a,currentMood:b}){let[d,e]=(0,c.useState)(a.output.color||"#FFD700"),[f,g]=(0,c.useState)(a.output.brightness||50),[h,i]=(0,c.useState)(a.output.scentLevel||5);return{lightColor:d,setLightColor:e,lightBrightness:f,setLightBrightness:g,scentLevel:h,setScentLevel:i,backgroundColor:a.power?b?(0,m.blendWithWhite)(b.color,.9):"rgb(255, 255, 255)":"rgba(200, 200, 200, 0.8)"}}({device:a,currentMood:d});return(0,b.jsxs)("div",{className:`p-4 rounded-xl shadow-md border relative animate-expand cursor-pointer transition-all min-h-[200px] backdrop-blur-sm
        ${a.power?"":"opacity-60"}
      `,style:{backgroundColor:a.power?`${t}CC`:"rgba(200, 200, 200, 0.8)"},onClick:e,children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"text-3xl",children:"manager"===(l=a.type)?(0,b.jsx)(H.FaPalette,{className:"text-purple-500 text-3xl"}):"light"===l?(0,b.jsx)(H.FaLightbulb,{className:"text-yellow-500 text-3xl"}):"scent"===l?(0,b.jsx)(H.FaSprayCan,{className:"text-green-500 text-3xl"}):"speaker"===l?(0,b.jsx)(H.FaVolumeUp,{className:"text-blue-500 text-3xl"}):(0,b.jsx)(H.FaCog,{className:"text-gray-500 text-3xl"})}),(0,b.jsx)(K,{name:a.name,onUpdate:h})]}),(0,b.jsxs)("div",{className:"text-sm font-medium",children:[a.battery,"%"]})]}),(0,b.jsx)("div",{className:"flex justify-center mt-4",children:(0,b.jsx)("button",{onClick:a=>{a.stopPropagation(),g()},className:"p-3 rounded-full transition-all text-white hover:opacity-80",style:{backgroundColor:a.power?d?.color||"#10b981":"rgba(156, 163, 175, 1)"},title:a.power?"Power On":"Power Off",children:(0,b.jsx)(J,{size:24})})}),(0,b.jsx)("div",{className:"mt-4 space-y-3",children:(0,b.jsx)(M,{device:a,currentMood:d,lightColor:n,lightBrightness:p,scentLevel:r,onUpdateLightColor:"light"===a.type?void 0:a=>{o(a),i?.(a)},onUpdateLightBrightness:a=>{q(a),j?.(a)},onUpdateScentLevel:a=>{s(a),k?.(a)}})}),(0,b.jsx)("div",{className:"mt-4 pb-8 text-sm text-gray-600 leading-relaxed",children:function(a){if(!a.power)return"Power is turned off.";switch(a.type){case"manager":let c=a.output.brightness?`Light Status: ${a.output.brightness}%`:"Light Status: -",d=a.output.scentType?`Scent Status: ${a.output.scentType} (Level ${a.output.scentLevel||0})`:"Scent Status: -",e=a.output.nowPlaying?`Music Status: ${a.output.nowPlaying}`:"Music Status: -";return(0,b.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,b.jsx)("div",{children:c}),(0,b.jsx)("div",{children:d}),(0,b.jsx)("div",{children:e})]});case"light":return a.output.brightness?`Light Status: ${a.output.brightness}%`:"Light Status: -";case"scent":return a.output.scentType?`Scent Status: ${a.output.scentType} (Level ${a.output.scentLevel||0})`:"Scent Status: -";case"speaker":return a.output.nowPlaying?`Music Status: ${a.output.nowPlaying}`:"Music Status: -";default:return""}}(a)}),(0,b.jsx)("div",{onClick:a=>{a.stopPropagation(),f()},className:"absolute bottom-4 right-4 text-red-500 text-sm underline cursor-pointer hover:text-red-700",children:"Delete"})]},`device-${a.id}-${a.power}`)}function O({onAdd:a,currentMood:d}){let[e,f]=(0,c.useState)(!1),g=d?.color||"#6B7280",h=d?(0,m.hexToRgba)(g,.25):"rgba(209, 213, 219, 0.4)",i=d?(0,m.blendWithWhite)(g,.9):"rgb(255, 255, 255)",j=d?(0,m.blendWithWhite)(g,.85):"rgb(240, 240, 240)";return(0,b.jsx)("div",{className:`h-[100px] p-3 rounded-xl shadow-sm cursor-pointer transition-all duration-150 flex flex-col justify-center items-center backdrop-blur-sm ${e?"scale-95":"scale-100"}`,style:{borderColor:h,borderWidth:"1px",borderStyle:"solid",backgroundColor:e?j:i},onClick:()=>{f(!0),setTimeout(()=>{f(!1),a()},150)},children:(0,b.jsx)("div",{className:"text-4xl font-light transition-colors duration-150",style:{color:e?(0,m.blendWithWhite)(g,.8):h},children:"+"})})}function P({devices:a,expandedId:d,setExpandedId:e,setDevices:f,openAddModal:g,currentMood:i,onDeleteRequest:j}){let[k,l]=(0,c.useState)(!0);(0,c.useEffect)(()=>{let a=setTimeout(()=>{l(!1)},500);return()=>clearTimeout(a)},[]);let m=null===d?a:[...a.filter(a=>a.id===d),...a.filter(a=>a.id!==d)];return k?(0,b.jsx)("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[1,2].map(a=>(0,b.jsx)(h.DeviceCardSkeleton,{},a))}):(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[m.map(a=>{if(d===a.id){let c=function({device:a,setDevices:b}){return{handleDelete:async()=>{try{let c=await fetch(`/api/devices/${a.id}`,{method:"DELETE",credentials:"include"});if(!c.ok){let a=await c.json();throw Error(a.message||"Failed to delete device")}b(b=>b.filter(b=>b.id!==a.id))}catch(a){console.error("Error deleting device:",a),alert("디바이스 삭제에 실패했습니다. 다시 시도해주세요.")}},handleTogglePower:async()=>{let c=a.power;b(b=>b.map(b=>b.id===a.id?{...b,power:!b.power}:b));try{let d=await fetch(`/api/devices/${a.id}/power`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({power:!c})});if(!d.ok){let a=await d.json();throw Error(a.message||"Failed to toggle power")}let e=await d.json();b(b=>b.map(b=>b.id===a.id?e.device:b))}catch(d){console.error("Error toggling power:",d),b(b=>b.map(b=>b.id===a.id?{...b,power:c}:b)),alert("전원 상태 변경에 실패했습니다. 다시 시도해주세요.")}},handleUpdateName:async c=>{let d=a.name;b(b=>b.map(b=>b.id===a.id?{...b,name:c}:b));try{let d=await fetch(`/api/devices/${a.id}/name`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:c})});if(!d.ok){let a=await d.json();throw Error(a.message||"Failed to update device name")}let e=await d.json();b(b=>b.map(b=>b.id===a.id?e.device:b))}catch(c){console.error("Error updating device name:",c),b(b=>b.map(b=>b.id===a.id?{...b,name:d}:b)),alert("디바이스 이름 변경에 실패했습니다. 다시 시도해주세요.")}},handleUpdateLightColor:c=>{b(b=>b.map(b=>b.id===a.id?{...b,output:{...b.output,color:c}}:b))},handleUpdateLightBrightness:c=>{b(b=>b.map(b=>b.id===a.id?{...b,output:{...b.output,brightness:c}}:b))},handleUpdateScentLevel:c=>{b(b=>b.map(b=>b.id===a.id?{...b,output:{...b.output,scentLevel:c}}:b))}}}({device:a,setDevices:f});return(0,b.jsx)("div",{className:"col-span-2 animate-grow",children:(0,b.jsx)(N,{device:a,currentMood:i,onClose:()=>e(null),onDelete:()=>j(a),onTogglePower:c.handleTogglePower,onUpdateName:c.handleUpdateName,onUpdateLightColor:c.handleUpdateLightColor,onUpdateLightBrightness:c.handleUpdateLightBrightness,onUpdateScentLevel:c.handleUpdateScentLevel})},a.id)}return(0,b.jsx)(I,{device:a,currentMood:i,onClick:()=>{d===a.id?e(null):e(a.id)}},a.id)}),(0,b.jsx)(O,{onAdd:g,currentMood:i})]})}let Q={Marine:{speed:{min:.8,max:1.5},size:{min:10,max:18},density:1,swayAmount:.2,rotationSpeed:.3,backgroundColor:"rgba(200, 230, 250, 0.08)"},Floral:{speed:{min:.4,max:.9},size:{min:14,max:24},density:.8,swayAmount:.6,rotationSpeed:.8,backgroundColor:"rgba(255, 220, 230, 0.08)"},Citrus:{speed:{min:1,max:1.8},size:{min:8,max:14},density:1.2,swayAmount:.3,rotationSpeed:1.2,backgroundColor:"rgba(255, 240, 200, 0.08)"},Woody:{speed:{min:.6,max:1.2},size:{min:12,max:20},density:.7,swayAmount:.4,rotationSpeed:.5,backgroundColor:"rgba(220, 200, 180, 0.06)"},Musk:{speed:{min:.3,max:.7},size:{min:16,max:26},density:.6,swayAmount:.3,rotationSpeed:.2,backgroundColor:"rgba(250, 248, 240, 0.08)"},Aromatic:{speed:{min:.5,max:1},size:{min:10,max:18},density:1,swayAmount:.5,rotationSpeed:.6,backgroundColor:"rgba(220, 235, 210, 0.08)"},Green:{speed:{min:.6,max:1.1},size:{min:12,max:20},density:.9,swayAmount:.5,rotationSpeed:.7,backgroundColor:"rgba(220, 250, 230, 0.08)"},Spicy:{speed:{min:1.2,max:2},size:{min:6,max:12},density:1.3,swayAmount:.4,rotationSpeed:1.5,backgroundColor:"rgba(255, 230, 220, 0.06)"},Honey:{speed:{min:.5,max:.9},size:{min:14,max:22},density:.8,swayAmount:.3,rotationSpeed:.4,backgroundColor:"rgba(255, 240, 200, 0.08)"},Dry:{speed:{min:.5,max:1},size:{min:8,max:16},density:.7,swayAmount:.3,rotationSpeed:.5,backgroundColor:"rgba(240, 230, 220, 0.06)"},Leathery:{speed:{min:.6,max:1.2},size:{min:10,max:18},density:.8,swayAmount:.3,rotationSpeed:.4,backgroundColor:"rgba(230, 220, 210, 0.06)"},Powdery:{speed:{min:.3,max:.6},size:{min:18,max:28},density:.6,swayAmount:.2,rotationSpeed:.2,backgroundColor:"rgba(255, 240, 245, 0.08)"}};function R({scentType:a,scentColor:d,intensity:e,className:f="",backgroundIcon:g,backgroundWind:h,animationSpeed:i=4,iconOpacity:j=.7,backgroundColor:k}){let l=(0,c.useRef)(null),n=(0,c.useRef)(void 0),o=(0,c.useRef)([]),[p,q]=(0,c.useState)(0),[r,s]=(0,c.useState)(""),t=Q[a];return(0,c.useEffect)(()=>{let a=t.backgroundColor;k&&(a=(0,m.blendWithWhite)(k,.9)),s(a)},[k,t.backgroundColor]),(0,c.useEffect)(()=>{q(Math.floor(50*t.density*(e/10)))},[a,e,t.density]),(0,c.useEffect)(()=>{if(!l.current)return;let b=l.current,c=b.getContext("2d");if(!c)return;let e=()=>{b.width=window.innerWidth,b.height=window.innerHeight};e(),window.addEventListener("resize",e),o.current=Array.from({length:p},(a,c)=>{var d=c/p*b.height*2-.5*b.height;let e=t.size,f=t.speed,g=f.min+Math.random()*(f.max-f.min),h=void 0!==d?d:Math.random()*b.height*1.5-.5*b.height;return{id:Math.random(),x:Math.random()*b.width,y:h,size:e.min+Math.random()*(e.max-e.min),speed:g,opacity:.6+.4*Math.random(),rotation:360*Math.random(),rotationSpeed:(Math.random()-.5)*2,windX:(Math.random()-.5)*.3,windY:(Math.random()-.5)*.2,turbulence:.5*Math.random()+.3,life:1,lifeSpeed:3e-4+5e-4*Math.random()}});let f=()=>{if(!c)return;let e=t.size,g=t.speed,l=k||d;c.fillStyle=r||t.backgroundColor,c.fillRect(0,0,b.width,b.height);let m=.001*Date.now();o.current.forEach((d,f)=>{if(d.life-=d.lifeSpeed,d.life<=0){let a=g.min+Math.random()*(g.max-g.min);d.x=Math.random()*b.width,d.y=-d.size,d.size=e.min+Math.random()*(e.max-e.min),d.speed=a,d.opacity=.6+.4*Math.random(),d.rotation=360*Math.random(),d.rotationSpeed=(Math.random()-.5)*2,d.windX=(Math.random()-.5)*.3,d.windY=(Math.random()-.5)*.2,d.turbulence=.5*Math.random()+.3,d.life=1,d.lifeSpeed=3e-4+5e-4*Math.random()}let k=h?.direction||180,n=h?.speed||3,o=k*Math.PI/180,p=Math.cos(o)*n*.1,q=Math.sin(o)*n*.1,r=Math.sin(.01*d.y+.5*m+f)*t.swayAmount*d.turbulence,s=d.windX+r+p,u=i?i/4:1;switch(d.y+=d.speed*(.9+.2*Math.random())*u+q,d.x+=s,d.y>b.height&&(d.y=-d.size,d.x=Math.random()*b.width,d.speed=g.min+Math.random()*(g.max-g.min),d.windX=(Math.random()-.5)*.2,d.turbulence=.5*Math.random()+.3,d.rotation=360*Math.random()),d.rotation+=d.rotationSpeed*t.rotationSpeed*(.9+.2*Math.random()),c.save(),c.translate(d.x,d.y),c.rotate(d.rotation*Math.PI/180),c.globalAlpha=d.opacity*d.life*(j||.7),c.fillStyle=l,c.strokeStyle=l,c.lineWidth=1,a){case"Floral":v=d.size,c.fillStyle=l,c.beginPath(),c.ellipse(0,0,v/2,v/3,0,0,2*Math.PI),c.fill(),c.beginPath(),c.arc(0,0,v/6,0,2*Math.PI),c.fill();break;case"Marine":w=d.size,c.fillStyle=l,c.beginPath(),c.arc(0,0,w/2,0,2*Math.PI),c.fill(),c.fillStyle="rgba(255, 255, 255, 0.5)",c.beginPath(),c.arc(-w/6,-w/6,w/6,0,2*Math.PI),c.fill(),c.fillStyle=l;break;case"Citrus":default:case"Powdery":x=d.size,c.fillStyle=l,c.beginPath(),c.arc(0,0,x/2,0,2*Math.PI),c.fill();break;case"Woody":case"Green":y=d.size,c.fillStyle=l,c.beginPath(),c.ellipse(0,0,y/2,y/3,0,0,2*Math.PI),c.fill(),c.strokeStyle=l,c.lineWidth=1,c.beginPath(),c.moveTo(0,-y/3),c.lineTo(0,y/3),c.stroke();break;case"Musk":var v,w,x,y,z,A,B,C,D,E=d.size;c.fillStyle=l;let F=E/3;c.beginPath(),c.arc(-F,0,F,0,2*Math.PI),c.arc(F,0,F,0,2*Math.PI),c.arc(0,-(.5*F),F,0,2*Math.PI),c.arc(0,.5*F,.8*F,0,2*Math.PI),c.fill();break;case"Aromatic":z=d.size,c.fillStyle=l,c.beginPath(),c.ellipse(0,0,z/2.5,z/3.5,0,0,2*Math.PI),c.fill();break;case"Spicy":A=d.size,c.fillStyle=l,c.beginPath(),c.arc(0,0,A/3,0,2*Math.PI),c.fill();break;case"Honey":B=d.size,c.fillStyle=l,c.beginPath(),c.ellipse(0,0,B/2.5,B/2,0,0,2*Math.PI),c.fill();break;case"Dry":C=d.size,c.fillStyle=l,c.beginPath(),c.arc(0,0,C/4,0,2*Math.PI),c.fill();break;case"Leathery":D=d.size,c.fillStyle=l,c.fillRect(-D/3,-D/3,D/1.5,D/1.5)}c.restore()}),n.current=requestAnimationFrame(f)};return f(),()=>{window.removeEventListener("resize",e),n.current&&cancelAnimationFrame(n.current)}},[p,a,d,k,t,h,i,j,r]),(0,b.jsx)("div",{className:`fixed inset-0 pointer-events-none z-0 ${f}`,style:{opacity:1},children:(0,b.jsx)("canvas",{ref:l,className:"absolute inset-0 w-full h-full",style:{mixBlendMode:"multiply"}})})}function S({moodState:a,deviceState:d,backgroundState:e}){let{current:f,onChange:g,onScentChange:h,onSongChange:i}=a,{devices:j,setDevices:k,expandedId:l,setExpandedId:m,onOpenAddModal:n,onDeleteRequest:p}=d,q=e?.onChange,{moodStream:r,isLoading:s}=o(),[t,u]=(0,c.useState)(!1),{backgroundParams:v,isLoading:w}=function(a,b=!1){let[d,e]=(0,c.useState)(null),[f,g]=(0,c.useState)(!1);return(0,c.useEffect)(()=>{!async function(){if(a&&b){if(!a.segments||!Array.isArray(a.segments)||0===a.segments.length)return console.warn("[useBackgroundParams] No segments available in mood stream");g(!0);try{let b=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({mode:"stream",segments:a.segments,forceFresh:!0})});if(401===b.status){window.location.href="/login";return}if(!b.ok)throw Error("Failed to fetch background params");let c=await b.json();console.log("[BackgroundParams] LLM response source:",c.source),e(c)}catch(b){console.error("Error fetching background params:",b),a.currentMood&&e({moodAlias:a.currentMood.name||"Calm Breeze",musicSelection:a.currentMood.music?.title||"Unknown",moodColor:a.currentMood.lighting?.color||"#E6F3FF",lighting:{brightness:50,temperature:4e3},backgroundIcon:{name:"FaLeaf",category:"nature"},backgroundWind:{direction:180,speed:3},animationSpeed:4,iconOpacity:.7,source:"fallback"})}finally{g(!1)}}}()},[a?.streamId,b,a]),{backgroundParams:d,isLoading:f}}(r,t);(0,c.useEffect)(()=>{t&&!w&&v&&u(!1),v&&q&&q(v)},[t,w,v,q]),function({setDevices:a,backgroundParams:b,currentMood:d}){(0,c.useEffect)(()=>{a(a=>a.map(a=>{if("manager"===a.type){let c=b?.moodColor||d.color,e=b?.lighting.brightness||a.output.brightness||80,f=b?.lighting.temperature;return{...a,output:{...a.output,color:c,brightness:e,temperature:f,scentType:d.scent.name,nowPlaying:d.song.title}}}if("light"===a.type){let c=b?.lighting.brightness||a.output.brightness||70,d=b?.lighting.temperature;return{...a,output:{...a.output,brightness:c,temperature:d}}}return"scent"===a.type?{...a,output:{...a.output,scentType:d.scent.name,scentLevel:a.output.scentLevel||7,scentInterval:a.output.scentInterval||30}}:"speaker"===a.type?{...a,output:{...a.output,nowPlaying:d.song.title,volume:a.output.volume||60}}:a}))},[b,d,a])}({setDevices:k,backgroundParams:v,currentMood:f});let x=(0,c.useMemo)(()=>j.find(a=>"manager"===a.type)?.output?.scentLevel||5,[j]),y=(0,c.useMemo)(()=>v?.moodColor||f.color,[v?.moodColor,f.color]),z=(0,c.useCallback)(()=>{u(!0)},[]),A=(0,c.useMemo)(()=>({...f,color:v?.moodColor||f.color}),[f,v?.moodColor]);return s&&!r?(0,b.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,b.jsx)("p",{className:"text-gray-500",children:"무드스트림을 불러오는 중..."})}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(R,{scentType:f.scent.type,scentColor:y,intensity:x,backgroundIcon:v?.backgroundIcon,backgroundWind:v?.backgroundWind,animationSpeed:v?.animationSpeed,iconOpacity:v?.iconOpacity,backgroundColor:y}),(0,b.jsxs)("div",{className:"pt-2 px-3 flex flex-col flex-1 overflow-hidden relative z-10",children:[(0,b.jsx)("div",{className:"flex-shrink-0 relative z-20",children:(0,b.jsx)(G,{mood:f,onMoodChange:g,onScentChange:h,onSongChange:i,backgroundParams:v,onRefreshRequest:z})}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto mt-1 pb-20",children:(0,b.jsx)(P,{devices:j,expandedId:l,setExpandedId:m,setDevices:k,openAddModal:n,currentMood:A,onDeleteRequest:p})})]})]})}let T=[{id:"manager",label:"Manager",icon:(0,b.jsx)(H.FaPalette,{className:"text-purple-500 text-3xl"})},{id:"light",label:"Light",icon:(0,b.jsx)(H.FaLightbulb,{className:"text-yellow-500 text-3xl"})},{id:"speaker",label:"Speaker",icon:(0,b.jsx)(H.FaVolumeUp,{className:"text-blue-500 text-3xl"})},{id:"scent",label:"Scent",icon:(0,b.jsx)(H.FaSprayCan,{className:"text-green-500 text-3xl"})}];function U({onConfirm:a,onClose:d}){let[e,f]=(0,c.useState)("light"),[g,h]=(0,c.useState)(""),[i,j]=(0,c.useState)(!1);return(0,b.jsx)("div",{className:"fixed inset-0 bg-black/50 flex justify-center items-center z-50",children:(0,b.jsxs)("div",{className:"bg-white w-[330px] rounded-xl p-6 shadow-xl relative",children:[(0,b.jsx)("h2",{className:"text-center text-lg font-semibold mb-4",children:"Device Connection"}),(0,b.jsx)("div",{className:"grid grid-cols-2 gap-3 mb-5",children:T.map(a=>(0,b.jsxs)("button",{onClick:()=>f(a.id),className:`p-3 rounded-xl flex flex-col items-center gap-1 border transition
                ${e===a.id?"border-black shadow-[0_0_8px_rgba(0,0,0,0.25)]":"border-gray-300"}
            `,children:[(0,b.jsx)("div",{className:"text-3xl",children:a.icon}),(0,b.jsx)("div",{className:"text-sm",children:a.label})]},a.id))}),(0,b.jsx)("input",{type:"text",placeholder:"Enter device name...",value:g,onChange:a=>h(a.target.value),className:"w-full border p-2 rounded-lg mb-5"}),(0,b.jsx)("button",{onClick:()=>{j(!0),setTimeout(()=>{a(e,g),j(!1)},1500)},className:"w-full py-2 bg-black text-white rounded-lg flex justify-center items-center",disabled:i,children:i?(0,b.jsx)("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):"Connect"}),(0,b.jsx)("button",{className:"w-full mt-3 py-2 bg-gray-200 rounded-lg",onClick:d,disabled:i,children:"Cancel"})]})})}function V({device:a,onConfirm:c,onCancel:d}){return(0,b.jsx)("div",{className:"fixed inset-0 bg-black/50 flex justify-center items-center z-50",children:(0,b.jsxs)("div",{className:"bg-white w-[330px] rounded-xl p-6 shadow-xl relative",children:[(0,b.jsx)("h2",{className:"text-center text-lg font-semibold mb-4",children:"Delete Device"}),(0,b.jsxs)("div",{className:"flex items-center gap-3 mb-6 p-3 bg-gray-50 rounded-lg",children:[(0,b.jsx)("div",{className:"text-3xl",children:(()=>{switch(a.type){case"manager":return(0,b.jsx)(H.FaPalette,{className:"text-purple-500 text-3xl"});case"light":return(0,b.jsx)(H.FaLightbulb,{className:"text-yellow-500 text-3xl"});case"scent":return(0,b.jsx)(H.FaSprayCan,{className:"text-green-500 text-3xl"});case"speaker":return(0,b.jsx)(H.FaVolumeUp,{className:"text-blue-500 text-3xl"});default:return null}})()}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"font-medium text-gray-800",children:a.name}),(0,b.jsx)("p",{className:"text-sm text-gray-500 capitalize",children:a.type})]})]}),(0,b.jsx)("p",{className:"text-center text-gray-600 mb-6 text-sm",children:"Are you sure you want to delete this device? This action cannot be undone."}),(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsx)("button",{onClick:d,className:"flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Cancel"}),(0,b.jsx)("button",{onClick:c,className:"flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium",children:"Delete"})]})]})})}var W=a.i(33508);let X=["Citrus","Floral","Woody","Fresh","Spicy","Sweet","Herbal","Fruity","Musk","Aromatic","Honey","Green","Dry","Leathery","Marine","Powdery"],Y=["newage","classical","jazz","ambient","nature","meditation","piano","guitar","orchestral","electronic"];function Z({onComplete:a,onSkip:d}){let[e,f]=(0,c.useState)("scent"),[g,h]=(0,c.useState)(new Set),[i,j]=(0,c.useState)(new Set),[k,l]=(0,c.useState)(!1),[m,n]=(0,c.useState)(!1),o=a=>{h(b=>{let c=new Set(b);return c.has(a)?c.delete(a):c.add(a),c})},p=a=>{j(b=>{let c=new Set(b);return c.has(a)?c.delete(a):c.add(a),c})},q=async()=>{l(!0);let b=X.filter(a=>!g.has(a)),c=Array.from(g);a(b,c,Y.filter(a=>!i.has(a)),Array.from(i))};return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40"}),(0,b.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:(0,b.jsxs)("div",{className:"relative bg-white rounded-xl p-6 w-[330px] shadow-xl",children:[(0,b.jsx)("button",{onClick:()=>n(!0),className:"absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full transition","aria-label":"Close",children:(0,b.jsx)(W.X,{size:20,className:"text-gray-500"})}),"scent"===e&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold mb-2",children:"Scent Preferences"}),(0,b.jsx)("p",{className:"text-gray-600 mb-6 text-sm",children:"Double-click (or double-tap) on scents you dislike to remove them. All other scents will be treated as preferred."}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2 mb-6 max-h-[60vh] overflow-y-auto",children:X.filter(a=>!g.has(a)).map(a=>(0,b.jsx)("button",{type:"button",onDoubleClick:()=>o(a),className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-all",children:a},a))}),g.size>0&&(0,b.jsxs)("div",{className:"mb-4",children:[(0,b.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:"Removed scents (double-click to restore):"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:Array.from(g).map(a=>(0,b.jsx)("button",{type:"button",onDoubleClick:()=>o(a),className:"px-4 py-2 rounded-lg text-sm font-medium bg-gray-400 text-white hover:bg-gray-500 transition-all line-through",children:a},a))})]}),(0,b.jsx)("button",{onClick:()=>{"scent"===e?f("music"):q()},className:"w-full py-3 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium",children:"Next"})]}),"music"===e&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold mb-2",children:"Music Genre Preferences"}),(0,b.jsx)("p",{className:"text-gray-600 mb-6 text-sm",children:"Double-click (or double-tap) on music genres you dislike to remove them. All other genres will be treated as preferred."}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2 mb-6 max-h-[60vh] overflow-y-auto",children:Y.filter(a=>!i.has(a)).map(a=>(0,b.jsx)("button",{type:"button",onDoubleClick:()=>p(a),className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-all",children:a},a))}),i.size>0&&(0,b.jsxs)("div",{className:"mb-4",children:[(0,b.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:"Removed genres (double-click to restore):"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:Array.from(i).map(a=>(0,b.jsx)("button",{type:"button",onDoubleClick:()=>p(a),className:"px-4 py-2 rounded-lg text-sm font-medium bg-gray-400 text-white hover:bg-gray-500 transition-all line-through",children:a},a))})]}),(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsx)("button",{onClick:()=>f("scent"),className:"flex-1 py-3 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium",children:"Back"}),(0,b.jsx)("button",{onClick:q,disabled:k,className:"flex-1 py-3 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:k?"Saving...":"Save"})]})]})]})}),m&&(0,b.jsx)("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/50",children:(0,b.jsxs)("div",{className:"bg-white rounded-xl p-6 w-[330px] shadow-xl",children:[(0,b.jsx)("h3",{className:"text-xl font-bold mb-4",children:"Skip Survey?"}),(0,b.jsx)("p",{className:"text-gray-600 mb-6",children:"If you skip, all preferences will be set to positive. You can change this later in settings."}),(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsx)("button",{onClick:()=>n(!1),className:"flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium",children:"No"}),(0,b.jsx)("button",{onClick:()=>{n(!1),d()},className:"flex-1 py-2 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium",children:"Yes, Skip"})]})]})})]})}let $={manager:1,light:2,speaker:3,scent:4};var _=a.i(6704);function aa(){let a=(0,e.useRouter)(),{status:h}=(0,d.useSession)();(0,c.useEffect)(()=>{if("unauthenticated"===h)return void a.replace("/login");if("loading"===h)return},[h,a]);let[i,k]=(0,c.useState)(null),[l,m]=(0,c.useState)(!1),[n,o]=(0,c.useState)(null),[p,q]=(0,c.useState)(null),r=j[0],{devices:s,setDevices:t,addDevice:u,isLoading:v}=function(a){let[b,d]=(0,c.useState)([]),[e,f]=(0,c.useState)(!0);(0,c.useEffect)(()=>{(async()=>{try{let a=await fetch("/api/devices",{method:"GET",credentials:"include"});if(401===a.status){window.location.href="/login";return}if(!a.ok)throw Error("Failed to fetch devices");let b=await a.json();Array.isArray(b.devices)?d(b.devices):d([])}catch(a){console.error("Error fetching devices:",a),d([])}finally{f(!1)}})()},[]),(0,c.useEffect)(()=>{d(b=>b.map(b=>"manager"===b.type?{...b,output:{...b.output,color:a.color,scentType:a.scent.name,nowPlaying:a.song.title}}:"light"===b.type?{...b,output:{...b.output,color:a.color}}:b))},[a]);let g=async(a,b)=>{try{let c=await fetch("/api/devices",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({type:a,name:b?.trim()||void 0})});if(!c.ok){let a=await c.json();throw Error(a.message||"Failed to create device")}let e=await c.json();d(a=>[...a,e.device].sort((a,b)=>{if($[a.type]!==$[b.type])return $[a.type]-$[b.type];let c=Number(a.id),d=Number(b.id);return isNaN(c)||isNaN(d)?a.id.localeCompare(b.id):c-d}))}catch(a){console.error("Error creating device:",a),alert("디바이스 생성에 실패했습니다. 다시 시도해주세요.")}};return{devices:b,setDevices:d,addDevice:g,isLoading:e}}(r),{currentMood:w,setCurrentMood:x,handleScentChange:y,handleSongChange:z}=function(a,b){let[d,e]=(0,c.useState)(a);return{currentMood:d,setCurrentMood:e,handleScentChange:a=>{e(a),b(b=>b.map(b=>"manager"===b.type?{...b,output:{...b.output,color:a.color,scentType:a.scent.name,nowPlaying:a.song.title}}:b))},handleSongChange:a=>{e(a),b(b=>b.map(b=>"manager"===b.type?{...b,output:{...b.output,color:a.color,scentType:a.scent.name,nowPlaying:a.song.title}}:b))}}}(r,t),{showSurvey:A,handleSurveyComplete:B,handleSurveySkip:C}=function(){let[a,b]=(0,c.useState)(!1);return(0,c.useEffect)(()=>{(async()=>{try{let a=await fetch("/api/auth/survey-status",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!a.ok)return;let c=await a.json();!1===c.hasSurvey&&b(!0)}catch(a){console.error("Error checking survey status:",a)}})()},[]),{showSurvey:a,handleSurveyComplete:async(a,c,d,e)=>{try{if(!(await fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({scentLiked:a,scentDisliked:c,colorLiked:[],colorDisliked:[],musicLiked:d,musicDisliked:e})})).ok)throw Error("Failed to save preferences");_.default.success("설문이 완료되었습니다!"),b(!1)}catch(a){console.error("Error saving survey:",a),_.default.error("설문 저장 중 오류가 발생했습니다.")}},handleSurveySkip:async()=>{try{if(!(await fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({scentLiked:["Citrus","Floral","Woody","Fresh","Spicy","Sweet","Herbal","Fruity","Musk","Aromatic","Honey","Green","Dry","Leathery","Marine","Powdery"],scentDisliked:[],colorLiked:[],colorDisliked:[],musicLiked:["newage","classical","jazz","ambient","nature","meditation","piano","guitar","orchestral","electronic"],musicDisliked:[]})})).ok&&!(await fetch("/api/auth/survey-skip",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"})).ok)throw Error("Failed to skip survey");_.default.success("설문을 건너뛰었습니다. (모든 항목을 긍정으로 처리했습니다)"),b(!1)}catch(a){console.error("Error skipping survey:",a),b(!1)}}}}();return"loading"===h||"unauthenticated"===h?(0,b.jsx)("div",{className:"flex flex-col h-screen overflow-hidden relative items-center justify-center",children:(0,b.jsx)("p",{className:"text-gray-500",children:"로딩 중..."})}):(0,b.jsxs)("div",{className:"flex flex-col h-screen overflow-hidden relative",children:[(0,b.jsx)(f.default,{}),v?(0,b.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,b.jsx)("p",{className:"text-gray-500",children:"디바이스 목록을 불러오는 중..."})}):(0,b.jsx)(S,{moodState:{current:w,onChange:x,onScentChange:y,onSongChange:z},deviceState:{devices:s,setDevices:t,expandedId:i,setExpandedId:k,onOpenAddModal:()=>m(!0),onDeleteRequest:a=>o(a)},backgroundState:{params:p,onChange:q}}),(0,b.jsx)(g.default,{currentMood:w,moodColor:p?.moodColor}),l&&(0,b.jsx)(U,{onClose:()=>m(!1),onConfirm:(a,b)=>{u(a,b),m(!1)}}),n&&(0,b.jsx)(V,{device:n,onConfirm:()=>{t(s.filter(a=>a.id!==n.id)),o(null),k(null)},onCancel:()=>o(null)}),A&&(0,b.jsx)(Z,{onComplete:B,onSkip:C})]})}}];

//# sourceMappingURL=src_app_%28main%29_home_page_tsx_d88e913c._.js.map