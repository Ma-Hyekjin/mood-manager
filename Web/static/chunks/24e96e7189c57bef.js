(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,72635,e=>{"use strict";e.s(["default",()=>ee],72635);var t=e.i(43476),a=e.i(71645),n=e.i(17255),o=e.i(18566),r=e.i(75218),l=e.i(30567),s=e.i(88442);let i={Musk:[{type:"Musk",name:"Cloud",color:"#F5F5DC"},{type:"Musk",name:"Cloud",color:"#FFFDD0"},{type:"Musk",name:"Cloud",color:"#F5DEB3"}],Aromatic:[{type:"Aromatic",name:"Herb",color:"#9CAF88"},{type:"Aromatic",name:"Lavender",color:"#B19CD9"}],Woody:[{type:"Woody",name:"Wood",color:"#8B4513"},{type:"Woody",name:"Wood",color:"#A0826D"},{type:"Woody",name:"Wood",color:"#704214"}],Citrus:[{type:"Citrus",name:"Orange",color:"#FFD700"},{type:"Citrus",name:"Lemon",color:"#FFA500"},{type:"Citrus",name:"Lime",color:"#32CD32"}],Green:[{type:"Green",name:"Sprout",color:"#00FF00"},{type:"Green",name:"Grass",color:"#50C878"}],Marine:[{type:"Marine",name:"Wave",color:"#87CEEB"},{type:"Marine",name:"Shell",color:"#00CED1"}],Floral:[{type:"Floral",name:"Rose",color:"#FF69B4"},{type:"Floral",name:"Rose",color:"#FF7F50"},{type:"Floral",name:"Rose",color:"#8B008B"}]},c=[{id:"calm-1",name:"Calm Breeze",color:"#E6F3FF",song:{title:"Calm Breeze",duration:182},scent:i.Marine[0]},{id:"calm-2",name:"Calm Breeze",color:"#D4E6F1",song:{title:"Ocean Waves",duration:195},scent:i.Marine[1]},{id:"calm-3",name:"Calm Breeze",color:"#AED6F1",song:{title:"Gentle Rain",duration:210},scent:i.Green[0]},{id:"focus-1",name:"Deep Focus",color:"#F5F5DC",song:{title:"Deep Focus",duration:240},scent:i.Musk[0]},{id:"focus-2",name:"Deep Focus",color:"#FFFDD0",song:{title:"Concentration",duration:220},scent:i.Musk[1]},{id:"focus-3",name:"Deep Focus",color:"#F5DEB3",song:{title:"Study Time",duration:200},scent:i.Musk[2]},{id:"energy-1",name:"Morning Energy",color:"#FFD700",song:{title:"Sunrise",duration:180},scent:i.Citrus[0]},{id:"energy-2",name:"Morning Energy",color:"#FFA500",song:{title:"Vitality",duration:190},scent:i.Citrus[1]},{id:"energy-3",name:"Morning Energy",color:"#32CD32",song:{title:"Fresh Start",duration:175},scent:i.Citrus[2]},{id:"relax-1",name:"Evening Relax",color:"#9CAF88",song:{title:"Soft Evening",duration:195},scent:i.Aromatic[0]},{id:"relax-2",name:"Evening Relax",color:"#B19CD9",song:{title:"Peaceful Night",duration:210},scent:i.Aromatic[1]},{id:"relax-3",name:"Evening Relax",color:"#8B4513",song:{title:"Cozy Fireplace",duration:225},scent:i.Woody[0]},{id:"romantic-1",name:"Romantic Night",color:"#FF69B4",song:{title:"Love Song",duration:200},scent:i.Floral[0]},{id:"romantic-2",name:"Romantic Night",color:"#FF7F50",song:{title:"Intimate",duration:185},scent:i.Floral[1]},{id:"romantic-3",name:"Romantic Night",color:"#8B008B",song:{title:"Passion",duration:195},scent:i.Floral[2]}];var d=e.i(72588),u=e.i(68821);e.i(47167);var m=e.i(75157);function h(){let e=Date.now(),t=Math.floor(e/6e5)%c.length,a=c[t],n=Array.from({length:10},(a,n)=>{let o=(t+n+Math.floor(3*Math.random()))%c.length,r=c[o];return{timestamp:e+18e4*n,duration:18e4,mood:{id:r.id,name:r.name,color:r.color,music:{genre:"newage",title:r.song.title},scent:{type:r.scent.type,name:r.scent.name},lighting:{color:r.color,rgb:(0,m.hexToRgb)(r.color)}}}});return{streamId:"mock-stream-".concat(Date.now()),currentMood:{id:a.id,name:a.name,color:a.color,music:{genre:"newage",title:a.song.title},scent:{type:a.scent.type,name:a.scent.name},lighting:{color:a.color,rgb:(0,m.hexToRgb)(a.color)}},segments:n,createdAt:e,userDataCount:0}}function p(){let[e,t]=(0,a.useState)(null),[n,o]=(0,a.useState)(!0),[r,l]=(0,a.useState)(0),s=(0,a.useCallback)(async()=>{o(!0);try{let e=await fetch("/api/moods/current",{credentials:"include"});if(401===e.status){window.location.href="/login";return}if(!e.ok)throw Error("Failed to fetch mood stream");let a=await e.json();if(!a.currentMood||!a.moodStream||!Array.isArray(a.moodStream)){console.warn("[useMoodStream] Invalid response format or no mood stream available");try{let e=h();t(e),l(0)}catch(e){console.error("[useMoodStream] Error loading mock data:",e),t(null),l(0)}return}let n="stream-".concat(Date.now());t({streamId:n,currentMood:a.currentMood,segments:a.moodStream,createdAt:Date.now(),userDataCount:a.userDataCount||0});let o=Date.now(),r=a.moodStream.findIndex(e=>e.timestamp<=o&&o<e.timestamp+e.duration);l(r>=0?r:0)}catch(e){console.error("Error fetching mood stream:",e);try{let e=h();t(e),l(0)}catch(e){console.error("Error loading mock data:",e),t(null)}}finally{o(!1)}},[]),i=(0,a.useCallback)(async()=>{o(!0);try{let e=await fetch("/api/moods/current/refresh",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include"});if(401===e.status){window.location.href="/login";return}if(!e.ok)throw Error("Failed to refresh mood stream");let a=await e.json();if(!a.currentMood||!a.moodStream||!Array.isArray(a.moodStream)){console.warn("[useMoodStream] Invalid refresh response, using mock data");let e=h();t(e),l(0);return}t({streamId:a.streamId||"stream-".concat(Date.now()),currentMood:a.currentMood,segments:a.moodStream,createdAt:Date.now(),userDataCount:a.userDataCount||0}),l(0)}catch(e){console.error("Error refreshing mood stream:",e);try{let e=h();t(e),l(0)}catch(e){console.error("Error loading mock data:",e)}}finally{o(!1)}},[]);(0,a.useEffect)(()=>{s()},[s]);let c=(null==e?void 0:e.segments[r])||null;return{moodStream:e,currentSegment:c,currentSegmentIndex:r,isLoading:n,refreshMoodStream:i,setCurrentSegmentIndex:l}}var g=e.i(75254);let x=(0,g.default)("refresh-ccw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]),y=(0,g.default)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]),f=(0,g.default)("heart",[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]]);function b(e){let{onComplete:n,x:o,y:r}=e,[l,s]=(0,a.useState)(!0);return((0,a.useEffect)(()=>{let e=setTimeout(()=>{s(!1),setTimeout(()=>{n()},300)},1200);return()=>clearTimeout(e)},[n]),l)?(0,t.jsxs)("div",{className:"fixed pointer-events-none z-50",style:{left:"".concat(o,"px"),top:"".concat(r,"px"),transform:"translate(-50%, -50%)"},children:[(0,t.jsx)("div",{className:"absolute animate-heart-float",style:{animationDelay:"0ms",transform:"translate(-20px, 0)"},children:(0,t.jsx)(f,{size:28,className:"text-red-500 fill-red-500"})}),(0,t.jsx)("div",{className:"absolute animate-heart-float",style:{animationDelay:"100ms",transform:"translate(20px, 0)"},children:(0,t.jsx)(f,{size:32,className:"text-red-500 fill-red-500"})})]}):null}function v(e){let{mood:n,isSaved:o,onSaveToggle:r,onRefresh:l,llmSource:s,onPreferenceClick:i,maxReached:c=!1}=e,[d,u]=(0,a.useState)(!1),[m,h]=(0,a.useState)(null),[p,g]=(0,a.useState)(0);return(0,t.jsxs)(t.Fragment,{children:[d&&m&&(0,t.jsx)(b,{x:m.x,y:m.y,onComplete:()=>{u(!1),h(null)}}),(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,t.jsx)("div",{className:"text-base font-semibold text-gray-800 cursor-pointer select-none",onDoubleClick:e=>{let t=Date.now();t-p<300?(!c&&i&&(h({x:e.clientX,y:e.clientY}),u(!0),i()),g(0)):g(t)},title:c?"최대 선호도 카운트(3)에 도달했습니다":"더블클릭하여 선호도 표시 (최대 3번)",children:n.name}),s&&(0,t.jsxs)("span",{className:"text-[10px] text-gray-500",children:["LLM: ",s]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),r()},className:"p-1.5 rounded-full bg-white/40 backdrop-blur hover:bg-white/60 transition ".concat(o?"text-yellow-500":"text-gray-400"),title:o?"저장된 무드 (클릭하여 제거)":"무드 저장하기",children:(0,t.jsx)(y,{size:16,fill:o?"currentColor":"none",strokeWidth:1.5*!o})}),(0,t.jsx)("button",{onClick:l,className:"p-1.5 rounded-full bg-white/40 backdrop-blur hover:bg-white/60 transition text-gray-800",title:"Refresh mood (same mood cluster)",children:(0,t.jsx)(x,{size:16})})]})]})]})}var j=e.i(40141);function w(e){return(0,j.GenIcon)({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 10m0 2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v7a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2z"},child:[]},{tag:"path",attr:{d:"M6 10v-4a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v4"},child:[]},{tag:"path",attr:{d:"M15 7h.01"},child:[]},{tag:"path",attr:{d:"M18 9h.01"},child:[]},{tag:"path",attr:{d:"M18 5h.01"},child:[]},{tag:"path",attr:{d:"M21 3h.01"},child:[]},{tag:"path",attr:{d:"M21 7h.01"},child:[]},{tag:"path",attr:{d:"M21 11h.01"},child:[]},{tag:"path",attr:{d:"M10 7h1"},child:[]}]})(e)}function k(e){let{mood:a,onScentClick:n,moodColor:o}=e,r=o||a.color;return(0,t.jsxs)("div",{className:"flex items-center justify-end gap-1.5 mb-2",children:[(0,t.jsx)("span",{className:"text-sm text-gray-700",children:a.scent.name}),(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),n()},className:"w-7 h-7 rounded-full shadow flex items-center justify-center hover:scale-105 transition cursor-pointer",style:{backgroundColor:(0,m.hexToRgba)(r,.85)},title:"Change scent",children:(0,t.jsx)(w,{size:16,style:{color:"#ffffff"}})})]})}function S(e){let{mood:a,onAlbumClick:n,musicSelection:o}=e;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"flex justify-center mb-2",children:(0,t.jsx)("button",{onClick:n,className:"w-20 h-20 rounded-full bg-white shadow-md border flex items-center justify-center text-xs font-medium hover:scale-105 transition cursor-pointer",children:"Album Art"})}),(0,t.jsx)("p",{className:"text-center text-xs font-medium mb-1.5 text-gray-800",children:o||a.song.title})]})}let C=(0,g.default)("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]),N=(0,g.default)("pause",[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]]),M=(0,g.default)("skip-back",[["path",{d:"M17.971 4.285A2 2 0 0 1 21 6v12a2 2 0 0 1-3.029 1.715l-9.997-5.998a2 2 0 0 1-.003-3.432z",key:"15892j"}],["path",{d:"M3 20V4",key:"1ptbpl"}]]),F=(0,g.default)("skip-forward",[["path",{d:"M21 4v16",key:"7j8fe9"}],["path",{d:"M6.029 4.285A2 2 0 0 0 3 6v12a2 2 0 0 0 3.029 1.715l9.997-5.998a2 2 0 0 0 .003-3.432z",key:"zs4d6"}]]);function P(e){let t=Math.floor(e/60),a=Math.floor(e%60);return"".concat(t,":").concat(a.toString().padStart(2,"0"))}function E(e){let{mood:a,progress:n,playing:o,onPlayToggle:r,onPrevious:l,onNext:s}=e;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"w-full flex items-center mb-2",children:[(0,t.jsx)("span",{className:"text-xs mr-2 text-gray-800",children:P(n)}),(0,t.jsx)("div",{className:"flex-1 h-1 bg-white/50 rounded",children:(0,t.jsx)("div",{className:"h-1 bg-black rounded",style:{width:"".concat(n/a.song.duration*100,"%")}})}),(0,t.jsx)("span",{className:"text-xs ml-2 text-gray-800",children:P(a.song.duration)})]}),(0,t.jsxs)("div",{className:"flex justify-center items-center gap-4 mb-3",children:[(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),l()},className:"p-1.5 text-gray-800",title:"Previous song",children:(0,t.jsx)(M,{size:18})}),(0,t.jsx)("button",{className:"p-2 bg-white rounded-full shadow text-gray-800",onClick:e=>{e.stopPropagation(),r()},title:o?"Pause":"Play",children:o?(0,t.jsx)(N,{size:16}):(0,t.jsx)(C,{size:16})}),(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),s()},className:"p-1.5 text-gray-800",title:"Next song",children:(0,t.jsx)(F,{size:18})})]})]})}function D(e){let{mood:a,currentIndex:n,totalSegments:o,onSegmentSelect:r,moodColorCurrent:l,moodColorPast:s}=e,i=l||a.color,c=s||(0,m.blendWithWhite)(i,.9),d=(0,m.blendWithWhite)(i,.97),u=o>0?o:10,h=n>=0?n<u?n:u-1:0,p=Array.from({length:u},(e,t)=>t);return(0,t.jsxs)("div",{className:"mb-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("span",{className:"text-xs text-gray-600",children:"Mood Duration"}),(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-800",children:[h+1,"/",u]})]}),(0,t.jsx)("div",{className:"w-full flex gap-[2px]",children:p.map(e=>{let a=e===h,n=e<h,o=a?i:n?c:d;return(0,t.jsx)("div",{className:"flex-1 h-2 rounded-full transition-all cursor-pointer hover:opacity-70",onClick:t=>{t.stopPropagation(),null==r||r(e)},style:{backgroundColor:o,opacity:a?1:n?.7:.35},title:"".concat(e+1,"번째 구간으로 이동")},e)})})]})}function L(e){let{mood:o,onMoodChange:r,onScentChange:l,onSongChange:i,backgroundParams:h,onRefreshRequest:g}=e,{moodStream:x,currentSegment:y,currentSegmentIndex:f,isLoading:j,refreshMoodStream:w,setCurrentSegmentIndex:C}=p(),{isLoading:N,playing:M,setPlaying:F,progress:P,isSaved:L,setIsSaved:A,handleScentClick:T,handlePreviousSong:z,handleNextSong:I,handleRefreshClick:W,handleAlbumClick:B,handlePreferenceClick:R,preferenceCount:O,maxReached:U}=function(e){var t;let{mood:o,onMoodChange:r,onScentChange:l,onSongChange:s,currentSegment:i}=e,{data:m}=(0,n.useSession)(),h=(null==m||null==(t=m.user)?void 0:t.email)===u.ADMIN_EMAIL,[p,g]=(0,a.useState)(!0),[x,y]=(0,a.useState)(!0),[f]=(0,a.useState)(20),[b,v]=(0,a.useState)(!1),[j]=(0,a.useState)(30),[w,k]=(0,a.useState)(0),[S,C]=(0,a.useState)(!1);(0,a.useEffect)(()=>{v(!1)},[o.id]),(0,a.useEffect)(()=>{let e=setTimeout(()=>{g(!1)},500);return()=>clearTimeout(e)},[]),(0,a.useEffect)(()=>{(async()=>{try{let t=await fetch("/api/moods/preference");if(t.ok){var e;let a=(null==(e=(await t.json()).moodPreferences)?void 0:e[o.id])||0;k(a),C(a>=3)}}catch(e){console.error("Error fetching preference count:",e)}})()},[o.id]);let N=e=>c.filter(t=>t.name===e),M=async()=>{var e,t,a;if(b)try{if(h){let e=(0,d.getSavedMoods)().find(e=>e.moodId===o.id);e&&((0,d.deleteSavedMood)(e.id),v(!1))}else{let t=await fetch("/api/moods/saved",{credentials:"include"});if(t.ok){let a=null==(e=(await t.json()).savedMoods)?void 0:e.find(e=>e.moodId===o.id);a&&(await fetch("/api/moods/saved/".concat(a.id),{method:"DELETE",credentials:"include"})).ok&&v(!1)}}}catch(e){console.error("Error removing saved mood:",e)}else try{let e=(null==i||null==(a=i.mood)||null==(t=a.music)?void 0:t.genre)||"newage",n={id:"saved-".concat(Date.now()),moodId:o.id,moodName:o.name,moodColor:o.color,music:{genre:e,title:o.song.title},scent:{type:o.scent.type,name:o.scent.name},preferenceCount:w,savedAt:Date.now()};h&&((0,d.saveMood)(n),v(!0)),(await fetch("/api/moods/saved",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({moodId:n.moodId,moodName:n.moodName,moodColor:n.moodColor,music:n.music,scent:n.scent,preferenceCount:n.preferenceCount})})).ok&&v(!0)}catch(e){console.error("Error saving mood:",e)}};return{isLoading:p,playing:x,setPlaying:y,progress:f,isSaved:b,setIsSaved:M,moodDuration:j,handleScentClick:async()=>{if(i)try{let e=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"scent",segment:i})});if(e.ok){let t=(await e.json()).scentType||o.scent.type,a={...o,scent:{...o.scent,type:t}};l(a);return}}catch(e){console.error("Error updating scent via LLM:",e)}let e=N(o.name);if(e.length<=1)return void console.warn("No alternative moods with same name found");let t=e.findIndex(e=>e.id===o.id);if(-1===t)return void l(e[0]);let a=(t+1)%e.length,n=e[a];if(n.scent.name!==o.scent.name||n.scent.type!==o.scent.type)l(n);else{let t=(a+1)%e.length,n=e[t];(n.scent.name!==o.scent.name||n.scent.type!==o.scent.type)&&l(n)}},handlePreviousSong:()=>{let e=N(o.name),t=e.findIndex(e=>e.id===o.id),a=0===t?e.length-1:t-1;s(e[a])},handleNextSong:()=>{let e=N(o.name),t=(e.findIndex(e=>e.id===o.id)+1)%e.length;s(e[t])},handleRefreshClick:()=>{let e=N(o.name);if(e.length>1){let t=e.filter(e=>e.id!==o.id);r(t[Math.floor(Math.random()*t.length)])}else r(c[Math.floor(Math.random()*c.length)])},handleAlbumClick:async()=>{if(i)try{let e=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"music",segment:i})});if(e.ok){let t=(await e.json()).musicSelection||o.song.title,a={...o,song:{...o.song,title:t}};s(a);return}}catch(e){console.error("Error updating music via LLM:",e)}r(c[Math.floor(Math.random()*c.length)])},handlePreferenceClick:async()=>{if(!S&&!(w>=3))try{var e,t;let a=(null==i||null==(t=i.mood)||null==(e=t.music)?void 0:e.genre)||"newage",n=o.scent.type,r=await fetch("/api/moods/preference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({moodId:o.id,moodName:o.name,musicGenre:a,scentType:n,moodColor:o.color})});if(!r.ok){let e=await r.json();throw e.maxReached&&(C(!0),k(3)),Error(e.error||"Failed to update preference")}let l=await r.json();k(l.currentCount),C(l.maxReached)}catch(e){console.error("Error updating preference:",e)}},preferenceCount:w,maxReached:S}}({mood:o,onMoodChange:r,onScentChange:l,onSongChange:i,currentSegment:y}),{baseColor:G,accentColor:H,displayAlias:J,llmSource:X}=function(e){let{mood:t,backgroundParams:n}=e;return(0,a.useMemo)(()=>{let e=(null==n?void 0:n.moodColor)||t.color,a=(0,m.blendWithWhite)(e,.9);return{baseColor:e,accentColor:a,displayAlias:(null==n?void 0:n.moodAlias)||t.name,llmSource:null==n?void 0:n.source}},[t.color,t.name,null==n?void 0:n.moodColor,null==n?void 0:n.moodAlias,null==n?void 0:n.source])}({mood:o,backgroundParams:h}),{heartAnimation:q,handleDashboardDoubleClick:V,clearHeartAnimation:Y}=function(){let[e,t]=(0,a.useState)(null),[n,o]=(0,a.useState)(0);return{heartAnimation:e,handleDashboardDoubleClick:(0,a.useCallback)(e=>{let a=Date.now();a-n<300?(t({x:e.clientX,y:e.clientY}),o(0)):o(a)},[n]),clearHeartAnimation:(0,a.useCallback)(()=>{t(null)},[])}}(),{handleSegmentSelect:_}=function(e){let{moodStream:t,currentMood:n,setCurrentSegmentIndex:o,onMoodChange:r}=e;return{handleSegmentSelect:(0,a.useCallback)(e=>{if(!t||!t.segments||0===t.segments.length)return void console.warn("Mood stream not available for segment selection");let a=Math.max(0,Math.min(e,t.segments.length-1));o(a);let l=t.segments[a];(null==l?void 0:l.mood)?r(function(e,t){var a,n,o;let r=(null==(a=e.scent)?void 0:a.type)||t.scent.type;return{id:e.id||t.id,name:e.name||t.name,color:e.color||t.color,song:{title:(null==(n=e.music)?void 0:n.title)||t.song.title,duration:t.song.duration},scent:{type:r,name:(null==(o=e.scent)?void 0:o.name)||t.scent.name,color:t.scent.color}}}(l.mood,n)):console.warn("Target segment mood not found",{clampedIndex:a,target:l})},[t,n,o,r])}}({moodStream:x,currentMood:o,setCurrentSegmentIndex:C,onMoodChange:r}),K=(0,a.useCallback)(()=>{w(),W(),null==g||g()},[w,W,g]);return N||j?(0,t.jsx)(s.MoodDashboardSkeleton,{}):(0,t.jsxs)(t.Fragment,{children:[q&&(0,t.jsx)(b,{x:q.x,y:q.y,onComplete:Y}),(0,t.jsxs)("div",{className:"rounded-xl px-3 mb-1 w-full backdrop-blur-sm border",style:{backgroundColor:(0,m.hexToRgba)(G,.25),borderColor:H,paddingTop:"11px",paddingBottom:"8px"},onDoubleClick:V,children:[(0,t.jsx)(v,{mood:{...o,name:J},isSaved:L,onSaveToggle:A,onRefresh:K,llmSource:X,onPreferenceClick:R,preferenceCount:O,maxReached:U}),(0,t.jsx)(k,{mood:o,onScentClick:T,moodColor:H}),(0,t.jsx)(S,{mood:o,onAlbumClick:B,musicSelection:null==h?void 0:h.musicSelection}),(0,t.jsx)(E,{mood:o,progress:P,playing:M,onPlayToggle:()=>F(!M),onPrevious:z,onNext:I}),(0,t.jsx)(D,{mood:o,currentIndex:f,totalSegments:(null==x?void 0:x.segments.length)||10,onSegmentSelect:_,moodColorCurrent:G,moodColorPast:H})]})]})}var A=e.i(11152);function T(e){var a,n;let{device:o,currentMood:r,onClick:l}=e,s=o.power?r?(0,m.blendWithWhite)(r.color,.9):"rgb(255, 255, 255)":"rgba(200, 200, 200, 0.8)";return(0,t.jsxs)("div",{onClick:l,className:"h-[100px] p-3 rounded-xl shadow-sm border cursor-pointer transition-all flex flex-col backdrop-blur-sm ".concat("manager"===o.type?"justify-between":"justify-start gap-2","\n        ").concat(o.power?"":"opacity-60","\n      "),style:{backgroundColor:o.power?"".concat(s,"CC"):"rgba(200, 200, 200, 0.8)"},children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"text-base",children:"manager"===(a=o.type)?(0,t.jsx)(A.FaPalette,{className:"text-purple-500"}):"light"===a?(0,t.jsx)(A.FaLightbulb,{className:"text-yellow-500"}):"scent"===a?(0,t.jsx)(A.FaSprayCan,{className:"text-green-500"}):"speaker"===a?(0,t.jsx)(A.FaVolumeUp,{className:"text-blue-500"}):(0,t.jsx)(A.FaCog,{className:"text-gray-500"})}),(0,t.jsx)("div",{className:"text-xs font-medium flex-1 truncate",children:o.name}),(0,t.jsx)("div",{className:"text-sm",children:(n=o.battery,o.power?n>=70?(0,t.jsx)(A.FaBatteryFull,{className:"text-green-500"}):n>=30?(0,t.jsx)(A.FaBatteryHalf,{className:"text-yellow-500"}):(0,t.jsx)(A.FaBatteryEmpty,{className:"text-red-500"}):(0,t.jsx)(A.FaBatteryFull,{className:"text-gray-400"}))})]}),(0,t.jsx)("div",{className:"text-xs text-gray-600",children:function(e){if(!e.power)return"Power Off";switch(e.type){case"manager":let a=e.output.brightness?"Light: ".concat(e.output.brightness,"%"):"Light: -",n=e.output.scentType?"Scent: ".concat(e.output.scentType):"Scent: -",o=e.output.nowPlaying?"Music: ".concat(e.output.nowPlaying):"Music: -";return(0,t.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,t.jsx)("div",{children:a}),(0,t.jsx)("div",{children:n}),(0,t.jsx)("div",{children:o})]});case"light":return e.output.brightness?"Light Status: ".concat(e.output.brightness,"%"):"Light Status: -";case"scent":return e.output.scentType?"Scent Status: ".concat(e.output.scentType," (Level ").concat(e.output.scentLevel||0,")"):"Scent Status: -";case"speaker":return e.output.nowPlaying?"Music Status: ".concat(e.output.nowPlaying):"Music Status: -";default:return""}}(o)})]},"device-small-".concat(o.id,"-").concat(o.power))}let z=(0,g.default)("power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);function I(e){let{name:n,onUpdate:o}=e,[r,l]=(0,a.useState)(!1),[s,i]=(0,a.useState)(n),c=()=>{""!==s.trim()&&s!==n?o(s.trim()):i(n),l(!1)};return r?(0,t.jsx)("input",{type:"text",value:s,onChange:e=>i(e.target.value),onBlur:c,onKeyDown:e=>{"Enter"===e.key?c():"Escape"===e.key&&(i(n),l(!1))},onClick:e=>e.stopPropagation(),className:"text-lg font-semibold bg-white border border-gray-300 rounded px-2 py-1 outline-none focus:ring-2 focus:ring-black",autoFocus:!0}):(0,t.jsx)("div",{className:"text-lg font-semibold cursor-text hover:underline",onClick:e=>{e.stopPropagation(),l(!0)},title:"Click to edit name",children:n})}let W=(0,g.default)("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);function B(e){let{device:a,currentMood:n,lightColor:o,lightBrightness:r,scentLevel:l,onUpdateLightColor:s,onUpdateLightBrightness:i,onUpdateScentLevel:c}=e;if(!a.power)return null;switch(a.type){case"light":return(0,t.jsx)("div",{className:"space-y-2",onClick:e=>e.stopPropagation(),children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Brightness: ",r,"%"]}),(0,t.jsx)("input",{type:"range",min:0,max:100,value:r,onChange:e=>{let t=Number(e.target.value);null==i||i(t)},className:"w-full",style:{accentColor:(null==n?void 0:n.color)||"#FFD700"}})]})});case"scent":return(0,t.jsx)("div",{className:"space-y-2",onClick:e=>e.stopPropagation(),children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Scent Level: ",l,"/10"]}),(0,t.jsx)("input",{type:"range",min:1,max:10,value:l,onChange:e=>{let t=Number(e.target.value);null==c||c(t)},className:"w-full",style:{accentColor:(null==n?void 0:n.color)||"#9CAF88"}})]})});case"speaker":return(0,t.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,t.jsxs)("div",{children:["Current: ",a.output.nowPlaying||"-"]}),(0,t.jsxs)("div",{className:"mt-1 flex items-center gap-1 text-gray-500",children:[(0,t.jsx)("span",{children:"Next song"}),(0,t.jsx)(W,{size:12})]})]});case"manager":return(0,t.jsxs)("div",{className:"space-y-2",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-xs text-gray-600 mb-1 block",children:"Light Color"}),(0,t.jsx)("input",{type:"color",value:o,onChange:e=>{let t=e.target.value;null==s||s(t)},className:"w-full h-8 rounded cursor-pointer"})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Light Brightness: ",r,"%"]}),(0,t.jsx)("input",{type:"range",min:0,max:100,value:r,onChange:e=>{let t=Number(e.target.value);null==i||i(t)},className:"w-full",style:{accentColor:o}})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"text-xs text-gray-600 mb-1 block",children:["Scent Level: ",l,"/10"]}),(0,t.jsx)("input",{type:"range",min:1,max:10,value:l,onChange:e=>{let t=Number(e.target.value);null==c||c(t)},className:"w-full",style:{accentColor:(null==n?void 0:n.color)||"#9CAF88"}})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-600 pt-2 border-t border-gray-200",children:[(0,t.jsxs)("div",{children:["Current: ",a.output.nowPlaying||"-"]}),(0,t.jsxs)("div",{className:"mt-1 flex items-center gap-1 text-gray-500",children:[(0,t.jsx)("span",{children:"Next song"}),(0,t.jsx)(W,{size:12})]})]})]});default:return null}}function R(e){var n;let{device:o,currentMood:r,onClose:l,onDelete:s,onTogglePower:i,onUpdateName:c,onUpdateLightColor:d,onUpdateLightBrightness:u,onUpdateScentLevel:h}=e,{lightColor:p,setLightColor:g,lightBrightness:x,setLightBrightness:y,scentLevel:f,setScentLevel:b,backgroundColor:v}=function(e){let{device:t,currentMood:n}=e,[o,r]=(0,a.useState)(t.output.color||"#FFD700"),[l,s]=(0,a.useState)(t.output.brightness||50),[i,c]=(0,a.useState)(t.output.scentLevel||5);return{lightColor:o,setLightColor:r,lightBrightness:l,setLightBrightness:s,scentLevel:i,setScentLevel:c,backgroundColor:t.power?n?(0,m.blendWithWhite)(n.color,.9):"rgb(255, 255, 255)":"rgba(200, 200, 200, 0.8)"}}({device:o,currentMood:r});return(0,t.jsxs)("div",{className:"p-4 rounded-xl shadow-md border relative animate-expand cursor-pointer transition-all min-h-[200px] backdrop-blur-sm\n        ".concat(o.power?"":"opacity-60","\n      "),style:{backgroundColor:o.power?"".concat(v,"CC"):"rgba(200, 200, 200, 0.8)"},onClick:l,children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"text-3xl",children:"manager"===(n=o.type)?(0,t.jsx)(A.FaPalette,{className:"text-purple-500 text-3xl"}):"light"===n?(0,t.jsx)(A.FaLightbulb,{className:"text-yellow-500 text-3xl"}):"scent"===n?(0,t.jsx)(A.FaSprayCan,{className:"text-green-500 text-3xl"}):"speaker"===n?(0,t.jsx)(A.FaVolumeUp,{className:"text-blue-500 text-3xl"}):(0,t.jsx)(A.FaCog,{className:"text-gray-500 text-3xl"})}),(0,t.jsx)(I,{name:o.name,onUpdate:c})]}),(0,t.jsxs)("div",{className:"text-sm font-medium",children:[o.battery,"%"]})]}),(0,t.jsx)("div",{className:"flex justify-center mt-4",children:(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),i()},className:"p-3 rounded-full transition-all text-white hover:opacity-80",style:{backgroundColor:o.power?(null==r?void 0:r.color)||"#10b981":"rgba(156, 163, 175, 1)"},title:o.power?"Power On":"Power Off",children:(0,t.jsx)(z,{size:24})})}),(0,t.jsx)("div",{className:"mt-4 space-y-3",children:(0,t.jsx)(B,{device:o,currentMood:r,lightColor:p,lightBrightness:x,scentLevel:f,onUpdateLightColor:"light"===o.type?void 0:e=>{g(e),null==d||d(e)},onUpdateLightBrightness:e=>{y(e),null==u||u(e)},onUpdateScentLevel:e=>{b(e),null==h||h(e)}})}),(0,t.jsx)("div",{className:"mt-4 pb-8 text-sm text-gray-600 leading-relaxed",children:function(e){if(!e.power)return"Power is turned off.";switch(e.type){case"manager":let a=e.output.brightness?"Light Status: ".concat(e.output.brightness,"%"):"Light Status: -",n=e.output.scentType?"Scent Status: ".concat(e.output.scentType," (Level ").concat(e.output.scentLevel||0,")"):"Scent Status: -",o=e.output.nowPlaying?"Music Status: ".concat(e.output.nowPlaying):"Music Status: -";return(0,t.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,t.jsx)("div",{children:a}),(0,t.jsx)("div",{children:n}),(0,t.jsx)("div",{children:o})]});case"light":return e.output.brightness?"Light Status: ".concat(e.output.brightness,"%"):"Light Status: -";case"scent":return e.output.scentType?"Scent Status: ".concat(e.output.scentType," (Level ").concat(e.output.scentLevel||0,")"):"Scent Status: -";case"speaker":return e.output.nowPlaying?"Music Status: ".concat(e.output.nowPlaying):"Music Status: -";default:return""}}(o)}),(0,t.jsx)("div",{onClick:e=>{e.stopPropagation(),s()},className:"absolute bottom-4 right-4 text-red-500 text-sm underline cursor-pointer hover:text-red-700",children:"Delete"})]},"device-".concat(o.id,"-").concat(o.power))}function O(e){let{onAdd:n,currentMood:o}=e,[r,l]=(0,a.useState)(!1),s=(null==o?void 0:o.color)||"#6B7280",i=o?(0,m.hexToRgba)(s,.25):"rgba(209, 213, 219, 0.4)",c=o?(0,m.blendWithWhite)(s,.9):"rgb(255, 255, 255)",d=o?(0,m.blendWithWhite)(s,.85):"rgb(240, 240, 240)";return(0,t.jsx)("div",{className:"h-[100px] p-3 rounded-xl shadow-sm cursor-pointer transition-all duration-150 flex flex-col justify-center items-center backdrop-blur-sm ".concat(r?"scale-95":"scale-100"),style:{borderColor:i,borderWidth:"1px",borderStyle:"solid",backgroundColor:r?d:c},onClick:()=>{l(!0),setTimeout(()=>{l(!1),n()},150)},children:(0,t.jsx)("div",{className:"text-4xl font-light transition-colors duration-150",style:{color:r?(0,m.blendWithWhite)(s,.8):i},children:"+"})})}function U(e){let{devices:n,expandedId:o,setExpandedId:r,setDevices:l,openAddModal:i,currentMood:c,onDeleteRequest:d}=e,[u,m]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=setTimeout(()=>{m(!1)},500);return()=>clearTimeout(e)},[]);let h=null===o?n:[...n.filter(e=>e.id===o),...n.filter(e=>e.id!==o)];return u?(0,t.jsx)("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[1,2].map(e=>(0,t.jsx)(s.DeviceCardSkeleton,{},e))}):(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3 mt-4",children:[h.map(e=>{if(o===e.id){let a=function(e){let{device:t,setDevices:a}=e;return{handleDelete:async()=>{try{let e=await fetch("/api/devices/".concat(t.id),{method:"DELETE",credentials:"include"});if(!e.ok){let t=await e.json();throw Error(t.message||"Failed to delete device")}a(e=>e.filter(e=>e.id!==t.id))}catch(e){console.error("Error deleting device:",e),alert("디바이스 삭제에 실패했습니다. 다시 시도해주세요.")}},handleTogglePower:async()=>{let e=t.power;a(e=>e.map(e=>e.id===t.id?{...e,power:!e.power}:e));try{let n=await fetch("/api/devices/".concat(t.id,"/power"),{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({power:!e})});if(!n.ok){let e=await n.json();throw Error(e.message||"Failed to toggle power")}let o=await n.json();a(e=>e.map(e=>e.id===t.id?o.device:e))}catch(n){console.error("Error toggling power:",n),a(a=>a.map(a=>a.id===t.id?{...a,power:e}:a)),alert("전원 상태 변경에 실패했습니다. 다시 시도해주세요.")}},handleUpdateName:async e=>{let n=t.name;a(a=>a.map(a=>a.id===t.id?{...a,name:e}:a));try{let n=await fetch("/api/devices/".concat(t.id,"/name"),{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:e})});if(!n.ok){let e=await n.json();throw Error(e.message||"Failed to update device name")}let o=await n.json();a(e=>e.map(e=>e.id===t.id?o.device:e))}catch(e){console.error("Error updating device name:",e),a(e=>e.map(e=>e.id===t.id?{...e,name:n}:e)),alert("디바이스 이름 변경에 실패했습니다. 다시 시도해주세요.")}},handleUpdateLightColor:e=>{a(a=>a.map(a=>a.id===t.id?{...a,output:{...a.output,color:e}}:a))},handleUpdateLightBrightness:e=>{a(a=>a.map(a=>a.id===t.id?{...a,output:{...a.output,brightness:e}}:a))},handleUpdateScentLevel:e=>{a(a=>a.map(a=>a.id===t.id?{...a,output:{...a.output,scentLevel:e}}:a))}}}({device:e,setDevices:l});return(0,t.jsx)("div",{className:"col-span-2 animate-grow",children:(0,t.jsx)(R,{device:e,currentMood:c,onClose:()=>r(null),onDelete:()=>d(e),onTogglePower:a.handleTogglePower,onUpdateName:a.handleUpdateName,onUpdateLightColor:a.handleUpdateLightColor,onUpdateLightBrightness:a.handleUpdateLightBrightness,onUpdateScentLevel:a.handleUpdateScentLevel})},e.id)}return(0,t.jsx)(T,{device:e,currentMood:c,onClick:()=>{o===e.id?r(null):r(e.id)}},e.id)}),(0,t.jsx)(O,{onAdd:i,currentMood:c})]})}let G={Marine:{speed:{min:.8,max:1.5},size:{min:10,max:18},density:1,swayAmount:.2,rotationSpeed:.3,backgroundColor:"rgba(200, 230, 250, 0.08)"},Floral:{speed:{min:.4,max:.9},size:{min:14,max:24},density:.8,swayAmount:.6,rotationSpeed:.8,backgroundColor:"rgba(255, 220, 230, 0.08)"},Citrus:{speed:{min:1,max:1.8},size:{min:8,max:14},density:1.2,swayAmount:.3,rotationSpeed:1.2,backgroundColor:"rgba(255, 240, 200, 0.08)"},Woody:{speed:{min:.6,max:1.2},size:{min:12,max:20},density:.7,swayAmount:.4,rotationSpeed:.5,backgroundColor:"rgba(220, 200, 180, 0.06)"},Musk:{speed:{min:.3,max:.7},size:{min:16,max:26},density:.6,swayAmount:.3,rotationSpeed:.2,backgroundColor:"rgba(250, 248, 240, 0.08)"},Aromatic:{speed:{min:.5,max:1},size:{min:10,max:18},density:1,swayAmount:.5,rotationSpeed:.6,backgroundColor:"rgba(220, 235, 210, 0.08)"},Green:{speed:{min:.6,max:1.1},size:{min:12,max:20},density:.9,swayAmount:.5,rotationSpeed:.7,backgroundColor:"rgba(220, 250, 230, 0.08)"},Spicy:{speed:{min:1.2,max:2},size:{min:6,max:12},density:1.3,swayAmount:.4,rotationSpeed:1.5,backgroundColor:"rgba(255, 230, 220, 0.06)"},Honey:{speed:{min:.5,max:.9},size:{min:14,max:22},density:.8,swayAmount:.3,rotationSpeed:.4,backgroundColor:"rgba(255, 240, 200, 0.08)"},Dry:{speed:{min:.5,max:1},size:{min:8,max:16},density:.7,swayAmount:.3,rotationSpeed:.5,backgroundColor:"rgba(240, 230, 220, 0.06)"},Leathery:{speed:{min:.6,max:1.2},size:{min:10,max:18},density:.8,swayAmount:.3,rotationSpeed:.4,backgroundColor:"rgba(230, 220, 210, 0.06)"},Powdery:{speed:{min:.3,max:.6},size:{min:18,max:28},density:.6,swayAmount:.2,rotationSpeed:.2,backgroundColor:"rgba(255, 240, 245, 0.08)"}};function H(e){let{scentType:n,scentColor:o,intensity:r,className:l="",backgroundIcon:s,backgroundWind:i,animationSpeed:c=4,iconOpacity:d=.7,backgroundColor:u}=e,h=(0,a.useRef)(null),p=(0,a.useRef)(void 0),g=(0,a.useRef)([]),[x,y]=(0,a.useState)(0),[f,b]=(0,a.useState)(""),v=G[n];return(0,a.useEffect)(()=>{let e=v.backgroundColor;u&&(e=(0,m.blendWithWhite)(u,.9)),b(e)},[u,v.backgroundColor]),(0,a.useEffect)(()=>{y(Math.floor(50*v.density*(r/10)))},[n,r,v.density]),(0,a.useEffect)(()=>{if(!h.current)return;let e=h.current,t=e.getContext("2d");if(!t)return;let a=()=>{e.width=window.innerWidth,e.height=window.innerHeight};a(),window.addEventListener("resize",a),g.current=Array.from({length:x},(t,a)=>{var n=a/x*e.height*2-.5*e.height;let o=v.size,r=v.speed,l=r.min+Math.random()*(r.max-r.min),s=void 0!==n?n:Math.random()*e.height*1.5-.5*e.height;return{id:Math.random(),x:Math.random()*e.width,y:s,size:o.min+Math.random()*(o.max-o.min),speed:l,opacity:.6+.4*Math.random(),rotation:360*Math.random(),rotationSpeed:(Math.random()-.5)*2,windX:(Math.random()-.5)*.3,windY:(Math.random()-.5)*.2,turbulence:.5*Math.random()+.3,life:1,lifeSpeed:3e-4+5e-4*Math.random()}});let r=()=>{if(!t)return;let a=v.size,l=v.speed,s=u||o;t.fillStyle=f||v.backgroundColor,t.fillRect(0,0,e.width,e.height);let m=.001*Date.now();g.current.forEach((o,r)=>{if(o.life-=o.lifeSpeed,o.life<=0){let t=l.min+Math.random()*(l.max-l.min);o.x=Math.random()*e.width,o.y=-o.size,o.size=a.min+Math.random()*(a.max-a.min),o.speed=t,o.opacity=.6+.4*Math.random(),o.rotation=360*Math.random(),o.rotationSpeed=(Math.random()-.5)*2,o.windX=(Math.random()-.5)*.3,o.windY=(Math.random()-.5)*.2,o.turbulence=.5*Math.random()+.3,o.life=1,o.lifeSpeed=3e-4+5e-4*Math.random()}let u=(null==i?void 0:i.direction)||180,h=(null==i?void 0:i.speed)||3,p=u*Math.PI/180,g=Math.cos(p)*h*.1,x=Math.sin(p)*h*.1,y=Math.sin(.01*o.y+.5*m+r)*v.swayAmount*o.turbulence,f=o.windX+y+g,b=c?c/4:1;switch(o.y+=o.speed*(.9+.2*Math.random())*b+x,o.x+=f,o.y>e.height&&(o.y=-o.size,o.x=Math.random()*e.width,o.speed=l.min+Math.random()*(l.max-l.min),o.windX=(Math.random()-.5)*.2,o.turbulence=.5*Math.random()+.3,o.rotation=360*Math.random()),o.rotation+=o.rotationSpeed*v.rotationSpeed*(.9+.2*Math.random()),t.save(),t.translate(o.x,o.y),t.rotate(o.rotation*Math.PI/180),t.globalAlpha=o.opacity*o.life*(d||.7),t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1,n){case"Floral":j=o.size,t.fillStyle=s,t.beginPath(),t.ellipse(0,0,j/2,j/3,0,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(0,0,j/6,0,2*Math.PI),t.fill();break;case"Marine":w=o.size,t.fillStyle=s,t.beginPath(),t.arc(0,0,w/2,0,2*Math.PI),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.5)",t.beginPath(),t.arc(-w/6,-w/6,w/6,0,2*Math.PI),t.fill(),t.fillStyle=s;break;case"Citrus":default:case"Powdery":k=o.size,t.fillStyle=s,t.beginPath(),t.arc(0,0,k/2,0,2*Math.PI),t.fill();break;case"Woody":case"Green":S=o.size,t.fillStyle=s,t.beginPath(),t.ellipse(0,0,S/2,S/3,0,0,2*Math.PI),t.fill(),t.strokeStyle=s,t.lineWidth=1,t.beginPath(),t.moveTo(0,-S/3),t.lineTo(0,S/3),t.stroke();break;case"Musk":var j,w,k,S,C,N,M,F,P,E=o.size;t.fillStyle=s;let D=E/3;t.beginPath(),t.arc(-D,0,D,0,2*Math.PI),t.arc(D,0,D,0,2*Math.PI),t.arc(0,-(.5*D),D,0,2*Math.PI),t.arc(0,.5*D,.8*D,0,2*Math.PI),t.fill();break;case"Aromatic":C=o.size,t.fillStyle=s,t.beginPath(),t.ellipse(0,0,C/2.5,C/3.5,0,0,2*Math.PI),t.fill();break;case"Spicy":N=o.size,t.fillStyle=s,t.beginPath(),t.arc(0,0,N/3,0,2*Math.PI),t.fill();break;case"Honey":M=o.size,t.fillStyle=s,t.beginPath(),t.ellipse(0,0,M/2.5,M/2,0,0,2*Math.PI),t.fill();break;case"Dry":F=o.size,t.fillStyle=s,t.beginPath(),t.arc(0,0,F/4,0,2*Math.PI),t.fill();break;case"Leathery":P=o.size,t.fillStyle=s,t.fillRect(-P/3,-P/3,P/1.5,P/1.5)}t.restore()}),p.current=requestAnimationFrame(r)};return r(),()=>{window.removeEventListener("resize",a),p.current&&cancelAnimationFrame(p.current)}},[x,n,o,u,v,i,c,d,f]),(0,t.jsx)("div",{className:"fixed inset-0 pointer-events-none z-0 ".concat(l),style:{opacity:1},children:(0,t.jsx)("canvas",{ref:h,className:"absolute inset-0 w-full h-full",style:{mixBlendMode:"multiply"}})})}function J(e){let{moodState:n,deviceState:o,backgroundState:r}=e,{current:l,onChange:s,onScentChange:i,onSongChange:c}=n,{devices:d,setDevices:u,expandedId:m,setExpandedId:h,onOpenAddModal:g,onDeleteRequest:x}=o,y=null==r?void 0:r.onChange,{moodStream:f,isLoading:b}=p(),[v,j]=(0,a.useState)(!1),{backgroundParams:w,isLoading:k}=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[n,o]=(0,a.useState)(null),[r,l]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{!async function(){if(e&&t){if(!e.segments||!Array.isArray(e.segments)||0===e.segments.length)return console.warn("[useBackgroundParams] No segments available in mood stream");l(!0);try{let t=await fetch("/api/ai/background-params",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({mode:"stream",segments:e.segments,forceFresh:!0})});if(401===t.status){window.location.href="/login";return}if(!t.ok)throw Error("Failed to fetch background params");let a=await t.json();console.log("[BackgroundParams] LLM response source:",a.source),o(a)}catch(t){if(console.error("Error fetching background params:",t),e.currentMood){var a,n;o({moodAlias:e.currentMood.name||"Calm Breeze",musicSelection:(null==(a=e.currentMood.music)?void 0:a.title)||"Unknown",moodColor:(null==(n=e.currentMood.lighting)?void 0:n.color)||"#E6F3FF",lighting:{brightness:50,temperature:4e3},backgroundIcon:{name:"FaLeaf",category:"nature"},backgroundWind:{direction:180,speed:3},animationSpeed:4,iconOpacity:.7,source:"fallback"})}}finally{l(!1)}}}()},[null==e?void 0:e.streamId,t,e]),{backgroundParams:n,isLoading:r}}(f,v);(0,a.useEffect)(()=>{v&&!k&&w&&j(!1),w&&y&&y(w)},[v,k,w,y]),function(e){let{setDevices:t,backgroundParams:n,currentMood:o}=e;(0,a.useEffect)(()=>{t(e=>e.map(e=>{if("manager"===e.type){let t=(null==n?void 0:n.moodColor)||o.color,a=(null==n?void 0:n.lighting.brightness)||e.output.brightness||80,r=null==n?void 0:n.lighting.temperature;return{...e,output:{...e.output,color:t,brightness:a,temperature:r,scentType:o.scent.name,nowPlaying:o.song.title}}}if("light"===e.type){let t=(null==n?void 0:n.lighting.brightness)||e.output.brightness||70,a=null==n?void 0:n.lighting.temperature;return{...e,output:{...e.output,brightness:t,temperature:a}}}return"scent"===e.type?{...e,output:{...e.output,scentType:o.scent.name,scentLevel:e.output.scentLevel||7,scentInterval:e.output.scentInterval||30}}:"speaker"===e.type?{...e,output:{...e.output,nowPlaying:o.song.title,volume:e.output.volume||60}}:e}))},[n,o,t])}({setDevices:u,backgroundParams:w,currentMood:l});let S=(0,a.useMemo)(()=>{var e,t;return(null==(t=d.find(e=>"manager"===e.type))||null==(e=t.output)?void 0:e.scentLevel)||5},[d]),C=(0,a.useMemo)(()=>(null==w?void 0:w.moodColor)||l.color,[null==w?void 0:w.moodColor,l.color]),N=(0,a.useCallback)(()=>{j(!0)},[]),M=(0,a.useMemo)(()=>({...l,color:(null==w?void 0:w.moodColor)||l.color}),[l,null==w?void 0:w.moodColor]);return b&&!f?(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-500",children:"무드스트림을 불러오는 중..."})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(H,{scentType:l.scent.type,scentColor:C,intensity:S,backgroundIcon:null==w?void 0:w.backgroundIcon,backgroundWind:null==w?void 0:w.backgroundWind,animationSpeed:null==w?void 0:w.animationSpeed,iconOpacity:null==w?void 0:w.iconOpacity,backgroundColor:C}),(0,t.jsxs)("div",{className:"pt-2 px-3 flex flex-col flex-1 overflow-hidden relative z-10",children:[(0,t.jsx)("div",{className:"flex-shrink-0 relative z-20",children:(0,t.jsx)(L,{mood:l,onMoodChange:s,onScentChange:i,onSongChange:c,backgroundParams:w,onRefreshRequest:N})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto mt-1 pb-20",children:(0,t.jsx)(U,{devices:d,expandedId:m,setExpandedId:h,setDevices:u,openAddModal:g,currentMood:M,onDeleteRequest:x})})]})]})}let X=[{id:"manager",label:"Manager",icon:(0,t.jsx)(A.FaPalette,{className:"text-purple-500 text-3xl"})},{id:"light",label:"Light",icon:(0,t.jsx)(A.FaLightbulb,{className:"text-yellow-500 text-3xl"})},{id:"speaker",label:"Speaker",icon:(0,t.jsx)(A.FaVolumeUp,{className:"text-blue-500 text-3xl"})},{id:"scent",label:"Scent",icon:(0,t.jsx)(A.FaSprayCan,{className:"text-green-500 text-3xl"})}];function q(e){let{onConfirm:n,onClose:o}=e,[r,l]=(0,a.useState)("light"),[s,i]=(0,a.useState)(""),[c,d]=(0,a.useState)(!1);return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/50 flex justify-center items-center z-50",children:(0,t.jsxs)("div",{className:"bg-white w-[330px] rounded-xl p-6 shadow-xl relative",children:[(0,t.jsx)("h2",{className:"text-center text-lg font-semibold mb-4",children:"Device Connection"}),(0,t.jsx)("div",{className:"grid grid-cols-2 gap-3 mb-5",children:X.map(e=>(0,t.jsxs)("button",{onClick:()=>l(e.id),className:"p-3 rounded-xl flex flex-col items-center gap-1 border transition\n                ".concat(r===e.id?"border-black shadow-[0_0_8px_rgba(0,0,0,0.25)]":"border-gray-300","\n            "),children:[(0,t.jsx)("div",{className:"text-3xl",children:e.icon}),(0,t.jsx)("div",{className:"text-sm",children:e.label})]},e.id))}),(0,t.jsx)("input",{type:"text",placeholder:"Enter device name...",value:s,onChange:e=>i(e.target.value),className:"w-full border p-2 rounded-lg mb-5"}),(0,t.jsx)("button",{onClick:()=>{d(!0),setTimeout(()=>{n(r,s),d(!1)},1500)},className:"w-full py-2 bg-black text-white rounded-lg flex justify-center items-center",disabled:c,children:c?(0,t.jsx)("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):"Connect"}),(0,t.jsx)("button",{className:"w-full mt-3 py-2 bg-gray-200 rounded-lg",onClick:o,disabled:c,children:"Cancel"})]})})}function V(e){let{device:a,onConfirm:n,onCancel:o}=e;return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/50 flex justify-center items-center z-50",children:(0,t.jsxs)("div",{className:"bg-white w-[330px] rounded-xl p-6 shadow-xl relative",children:[(0,t.jsx)("h2",{className:"text-center text-lg font-semibold mb-4",children:"Delete Device"}),(0,t.jsxs)("div",{className:"flex items-center gap-3 mb-6 p-3 bg-gray-50 rounded-lg",children:[(0,t.jsx)("div",{className:"text-3xl",children:(()=>{switch(a.type){case"manager":return(0,t.jsx)(A.FaPalette,{className:"text-purple-500 text-3xl"});case"light":return(0,t.jsx)(A.FaLightbulb,{className:"text-yellow-500 text-3xl"});case"scent":return(0,t.jsx)(A.FaSprayCan,{className:"text-green-500 text-3xl"});case"speaker":return(0,t.jsx)(A.FaVolumeUp,{className:"text-blue-500 text-3xl"});default:return null}})()}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"font-medium text-gray-800",children:a.name}),(0,t.jsx)("p",{className:"text-sm text-gray-500 capitalize",children:a.type})]})]}),(0,t.jsx)("p",{className:"text-center text-gray-600 mb-6 text-sm",children:"Are you sure you want to delete this device? This action cannot be undone."}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{onClick:o,className:"flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Cancel"}),(0,t.jsx)("button",{onClick:n,className:"flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium",children:"Delete"})]})]})})}var Y=e.i(37727);let _=["Citrus","Floral","Woody","Fresh","Spicy","Sweet","Herbal","Fruity","Musk","Aromatic","Honey","Green","Dry","Leathery","Marine","Powdery"],K=["newage","classical","jazz","ambient","nature","meditation","piano","guitar","orchestral","electronic"];function Q(e){let{onComplete:n,onSkip:o}=e,[r,l]=(0,a.useState)("scent"),[s,i]=(0,a.useState)(new Set),[c,d]=(0,a.useState)(new Set),[u,m]=(0,a.useState)(!1),[h,p]=(0,a.useState)(!1),g=e=>{i(t=>{let a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},x=e=>{d(t=>{let a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},y=async()=>{m(!0);let e=_.filter(e=>!s.has(e)),t=Array.from(s);n(e,t,K.filter(e=>!c.has(e)),Array.from(c))};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40"}),(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:(0,t.jsxs)("div",{className:"relative bg-white rounded-xl p-6 w-[330px] shadow-xl",children:[(0,t.jsx)("button",{onClick:()=>p(!0),className:"absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full transition","aria-label":"Close",children:(0,t.jsx)(Y.X,{size:20,className:"text-gray-500"})}),"scent"===r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-2",children:"Scent Preferences"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6 text-sm",children:"Double-click (or double-tap) on scents you dislike to remove them. All other scents will be treated as preferred."}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2 mb-6 max-h-[60vh] overflow-y-auto",children:_.filter(e=>!s.has(e)).map(e=>(0,t.jsx)("button",{type:"button",onDoubleClick:()=>g(e),className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-all",children:e},e))}),s.size>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:"Removed scents (double-click to restore):"}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2",children:Array.from(s).map(e=>(0,t.jsx)("button",{type:"button",onDoubleClick:()=>g(e),className:"px-4 py-2 rounded-lg text-sm font-medium bg-gray-400 text-white hover:bg-gray-500 transition-all line-through",children:e},e))})]}),(0,t.jsx)("button",{onClick:()=>{"scent"===r?l("music"):y()},className:"w-full py-3 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium",children:"Next"})]}),"music"===r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-2",children:"Music Genre Preferences"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6 text-sm",children:"Double-click (or double-tap) on music genres you dislike to remove them. All other genres will be treated as preferred."}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2 mb-6 max-h-[60vh] overflow-y-auto",children:K.filter(e=>!c.has(e)).map(e=>(0,t.jsx)("button",{type:"button",onDoubleClick:()=>x(e),className:"px-4 py-2 rounded-lg text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-all",children:e},e))}),c.size>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:"Removed genres (double-click to restore):"}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2",children:Array.from(c).map(e=>(0,t.jsx)("button",{type:"button",onDoubleClick:()=>x(e),className:"px-4 py-2 rounded-lg text-sm font-medium bg-gray-400 text-white hover:bg-gray-500 transition-all line-through",children:e},e))})]}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{onClick:()=>l("scent"),className:"flex-1 py-3 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium",children:"Back"}),(0,t.jsx)("button",{onClick:y,disabled:u,className:"flex-1 py-3 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:u?"Saving...":"Save"})]})]})]})}),h&&(0,t.jsx)("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/50",children:(0,t.jsxs)("div",{className:"bg-white rounded-xl p-6 w-[330px] shadow-xl",children:[(0,t.jsx)("h3",{className:"text-xl font-bold mb-4",children:"Skip Survey?"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6",children:"If you skip, all preferences will be set to positive. You can change this later in settings."}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{onClick:()=>p(!1),className:"flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium",children:"No"}),(0,t.jsx)("button",{onClick:()=>{p(!1),o()},className:"flex-1 py-2 px-4 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium",children:"Yes, Skip"})]})]})})]})}let Z={manager:1,light:2,speaker:3,scent:4};var $=e.i(5766);function ee(){let e=(0,o.useRouter)(),{status:s}=(0,n.useSession)();(0,a.useEffect)(()=>{if("unauthenticated"===s)return void e.replace("/login");if("loading"===s)return},[s,e]);let[i,d]=(0,a.useState)(null),[u,m]=(0,a.useState)(!1),[h,p]=(0,a.useState)(null),[g,x]=(0,a.useState)(null),y=c[0],{devices:f,setDevices:b,addDevice:v,isLoading:j}=function(e){let[t,n]=(0,a.useState)([]),[o,r]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/devices",{method:"GET",credentials:"include"});if(401===e.status){window.location.href="/login";return}if(!e.ok)throw Error("Failed to fetch devices");let t=await e.json();Array.isArray(t.devices)?n(t.devices):n([])}catch(e){console.error("Error fetching devices:",e),n([])}finally{r(!1)}})()},[]),(0,a.useEffect)(()=>{n(t=>t.map(t=>"manager"===t.type?{...t,output:{...t.output,color:e.color,scentType:e.scent.name,nowPlaying:e.song.title}}:"light"===t.type?{...t,output:{...t.output,color:e.color}}:t))},[e]);let l=async(e,t)=>{try{let a=await fetch("/api/devices",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({type:e,name:(null==t?void 0:t.trim())||void 0})});if(!a.ok){let e=await a.json();throw Error(e.message||"Failed to create device")}let o=await a.json();n(e=>[...e,o.device].sort((e,t)=>{if(Z[e.type]!==Z[t.type])return Z[e.type]-Z[t.type];let a=Number(e.id),n=Number(t.id);return isNaN(a)||isNaN(n)?e.id.localeCompare(t.id):a-n}))}catch(e){console.error("Error creating device:",e),alert("디바이스 생성에 실패했습니다. 다시 시도해주세요.")}};return{devices:t,setDevices:n,addDevice:l,isLoading:o}}(y),{currentMood:w,setCurrentMood:k,handleScentChange:S,handleSongChange:C}=function(e,t){let[n,o]=(0,a.useState)(e);return{currentMood:n,setCurrentMood:o,handleScentChange:e=>{o(e),t(t=>t.map(t=>"manager"===t.type?{...t,output:{...t.output,color:e.color,scentType:e.scent.name,nowPlaying:e.song.title}}:t))},handleSongChange:e=>{o(e),t(t=>t.map(t=>"manager"===t.type?{...t,output:{...t.output,color:e.color,scentType:e.scent.name,nowPlaying:e.song.title}}:t))}}}(y,b),{showSurvey:N,handleSurveyComplete:M,handleSurveySkip:F}=function(){let[e,t]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/auth/survey-status",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!e.ok)return;let a=await e.json();!1===a.hasSurvey&&t(!0)}catch(e){console.error("Error checking survey status:",e)}})()},[]),{showSurvey:e,handleSurveyComplete:async(e,a,n,o)=>{try{if(!(await fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({scentLiked:e,scentDisliked:a,colorLiked:[],colorDisliked:[],musicLiked:n,musicDisliked:o})})).ok)throw Error("Failed to save preferences");$.default.success("설문이 완료되었습니다!"),t(!1)}catch(e){console.error("Error saving survey:",e),$.default.error("설문 저장 중 오류가 발생했습니다.")}},handleSurveySkip:async()=>{try{if(!(await fetch("/api/preferences",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({scentLiked:["Citrus","Floral","Woody","Fresh","Spicy","Sweet","Herbal","Fruity","Musk","Aromatic","Honey","Green","Dry","Leathery","Marine","Powdery"],scentDisliked:[],colorLiked:[],colorDisliked:[],musicLiked:["newage","classical","jazz","ambient","nature","meditation","piano","guitar","orchestral","electronic"],musicDisliked:[]})})).ok&&!(await fetch("/api/auth/survey-skip",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"})).ok)throw Error("Failed to skip survey");$.default.success("설문을 건너뛰었습니다. (모든 항목을 긍정으로 처리했습니다)"),t(!1)}catch(e){console.error("Error skipping survey:",e),t(!1)}}}}();return"loading"===s||"unauthenticated"===s?(0,t.jsx)("div",{className:"flex flex-col h-screen overflow-hidden relative items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-500",children:"로딩 중..."})}):(0,t.jsxs)("div",{className:"flex flex-col h-screen overflow-hidden relative",children:[(0,t.jsx)(r.default,{}),j?(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-gray-500",children:"디바이스 목록을 불러오는 중..."})}):(0,t.jsx)(J,{moodState:{current:w,onChange:k,onScentChange:S,onSongChange:C},deviceState:{devices:f,setDevices:b,expandedId:i,setExpandedId:d,onOpenAddModal:()=>m(!0),onDeleteRequest:e=>p(e)},backgroundState:{params:g,onChange:x}}),(0,t.jsx)(l.default,{currentMood:w,moodColor:null==g?void 0:g.moodColor}),u&&(0,t.jsx)(q,{onClose:()=>m(!1),onConfirm:(e,t)=>{v(e,t),m(!1)}}),h&&(0,t.jsx)(V,{device:h,onConfirm:()=>{b(f.filter(e=>e.id!==h.id)),p(null),d(null)},onCancel:()=>p(null)}),N&&(0,t.jsx)(Q,{onComplete:M,onSkip:F})]})}}]);