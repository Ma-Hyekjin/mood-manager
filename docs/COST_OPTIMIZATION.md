# OpenAI 비용 최적화 가이드

## 최소 비용 전략

### 1. 모델 선택
- **gpt-4o-mini**: 가장 저렴한 모델 사용
- 비용: 입력 $0.15/1M 토큰, 출력 $0.60/1M 토큰

### 2. 프롬프트 최적화
- **구조화된 JSON 요청**: Few-shot 대신 구조 명시
- **불필요한 설명 제거**: 핵심 정보만 포함
- **예시 최소화**: 예시 없이 구조만 명시
- **간소화된 표현**: 긴 설명을 짧은 키워드로

**예시:**
```
기존: "당신은 감성적인 무드 배경을 설계하는 전문가입니다. 항상 JSON 형식으로 응답하세요. [상세한 설명...]"
최적화: "JSON만 응답"
```

### 3. 토큰 제한
- **max_tokens: 500**: 최소한의 토큰만 사용
- JSON 응답이므로 500 토큰으로 충분

### 4. 캐싱
- **같은 입력에 대해 캐시 사용**
- 캐시 키: 무드명 + 장르 + 향 + 시간대 + 계절 + 스트레스 범위
- TTL: 1시간
- 비용 절감: 같은 조건에서 재요청 시 100% 절감

### 5. 배치 처리 (향후)
- 여러 요청을 한 번에 처리
- 현재는 단일 요청만 지원

---

## 비용 계산

### 예상 비용 (gpt-4o-mini 기준)

**프롬프트 크기:**
- 최적화 전: ~500 토큰
- 최적화 후: ~200 토큰

**응답 크기:**
- JSON 응답: ~100 토큰

**1회 요청 비용:**
- 입력: 200 토큰 × $0.15/1M = $0.00003
- 출력: 100 토큰 × $0.60/1M = $0.00006
- **총: $0.00009 (약 0.01원)**

**캐싱 적용 시:**
- 첫 요청: $0.00009
- 캐시 히트: $0 (100% 절감)
- **평균 비용: $0.00003 (50% 절감)**

---

## 🔧 구현된 최적화

### 1. 최적화된 프롬프트
- `generateOptimizedPrompt()`: 토큰 최소화
- 핵심 정보만 포함
- 간소화된 표현

### 2. 캐싱 시스템
- `llmCache.ts`: 메모리 기반 캐싱
- 같은 조건에서 1시간 동안 캐시 사용
- 캐시 크기 제한: 최대 100개

### 3. 토큰 제한
- `max_tokens: 500`: 최소한의 토큰만 사용

### 4. 모델 선택
- `gpt-4o-mini`: 가장 저렴한 모델

---

## 🚀 테스트 가능 여부

### 현재 상태: ✅ 테스트 가능

**필요한 것:**
1. `.env.local`에 `OPENAI_API_KEY` 설정 (이미 설정됨)
2. 서버 실행: `npm run dev`
3. MoodDashboard에서 무드 변경 시 자동으로 OpenAI 호출

**테스트 방법:**
1. 홈 페이지 접속
2. 무드 변경 (또는 새로고침)
3. 콘솔에서 OpenAI 호출 로그 확인
4. MoodDashboard에 LLM 추천 별명/색상 표시 확인

**목업 데이터로 테스트:**
- `/api/preprocessing`과 `/api/moods/current`는 목업 데이터 반환
- 이 데이터를 OpenAI에 전송하여 실제 응답 받음
- ✅ 지금 당장 테스트 가능

---

## 📋 추가 최적화 방안

### 1. 프롬프트 템플릿
- 자주 사용하는 부분을 템플릿으로
- 동적 부분만 채워넣기

### 2. 스트리밍 응답
- 전체 응답 대신 스트리밍으로 받기
- 필요한 부분만 파싱

### 3. Redis 캐싱
- 메모리 캐시 대신 Redis 사용
- 서버 재시작 후에도 캐시 유지

### 4. 배치 처리
- 여러 요청을 한 번에 처리
- 비용 절감

---

## 요약

**현재 구성:**
- 최소 비용 모델 사용 (gpt-4o-mini)
- 프롬프트 최적화 (토큰 최소화)
- 캐싱 시스템 (50% 비용 절감 예상)
- 토큰 제한 (max_tokens: 500)

**테스트 가능 여부:**
- 목업 데이터를 OpenAI에 보내는 테스트 가능
- `.env.local` 에 API 키가 있으면 즉시 동작

**예상 비용(대략치):**
- 1회 요청: 약 0.01원
- 캐싱 적용 시: 평균 0.005원 수준

