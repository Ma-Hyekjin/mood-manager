# V1/V2 개발 계획

## 📋 목표 이해

### V1 (목업 모드 - 현재 목표)
**목표**: 어드민 모드에서 DB 없이도 완전한 플로우를 경험할 수 있도록 목업 데이터로 모든 기능이 유기적으로 연결

**핵심 요구사항**:
1. 어드민 로그인 → 설문 → 홈화면
2. 홈화면 진입 시 초기 1세그먼트 디폴트 수행
3. 수집한 정보를 당겨와서 전처리
4. 시계열+마르코프로 돌려서 값들을 모아서 LLM에 쏴서 아웃풋 생성
5. 홈화면에 무드 대시보드와 디바이스 카드 표시
6. 마이페이지에서 어드민 모드 확인 가능
7. 무드 페이지에 목업 무드셋 표시
8. 세그먼트 교체 또는 스트림 교체 경험 가능
9. 홈화면에서 별표 클릭 시 어드민 모드일 때 DB에 넣지 않고도 확인 가능
10. 목업만으로 생성과 정보전달이 유기적으로 연결
11. 배포해서 어드민 모드일 때 자연스러운 플로우 확인 가능

**음악 재생(음성 출력) 관점에서의 V1 제약**:
- 실제 음원을 브라우저/PC 스피커로 재생하지 않고, **“트랙 이름/장르만 UI에 표시”하는 수준의 목업**으로 유지
- LLM/Python이 선택한 음악 장르·타이틀은 UI 상에서만 확인 (실제 오디오 스트림은 없음)
- 이유:  
  - V1은 “데이터 파이프라인 + 무드스트림 UX” 검증이 목표  
  - 음원 확보/저작권/스트리밍 API 연동은 V2에서 다루는 것이 안전

### V2 (DB + 실제 출력장치 연동)
**목표**: V1의 모든 과정을 사용자 아이디 기반으로 저장/갱신하고, **실제 출력장치(스마트 조명/향 연동)** 까지 이어지는 “실환경” 파이프라인 구축

**핵심 요구사항**:
- 배포와 마이그레이션, 데이터 파이프라인이 유효한 상황에서 유효한 코드
- V1의 모든 기능이 DB 기반으로 동작
- 사용자별 데이터 격리 및 영구 저장
- **조명/향 등 실제 출력장치와의 연동**
  - 스마트 RGB 조명 (웹 상의 무드컬러 → 실제 조명 컬러)
  - Philips Wiz 스마트 전구 (라즈베리파이 경유 제어)
  - 향은 실제 하드웨어가 없으므로, **Web에서 “향이 선택될 때마다” 액션 트리거** (로그, 시뮬레이션 UI, 또는 조명/사운드와 연계된 피드백 등)
  - 현재 설계: **조명컬러 ≒ 무드컬러의 파스텔 버전** → 무드 대시보드 배경색과 동기화
- **실제 음악 재생(PC/강의실 스피커 출력)**:
  - 최소 목표: **PC에서 프로젝트를 실행했을 때, 선택된 무드/세그먼트에 맞는 실제 음원이 스피커로 재생**
  - 구현 단계 (V2 내부 단계로 분리):
    1. **V2-M1 (로컬 음원 매핑 목업)**  
       - 소량의 로컬 음악 파일(예: `/public/audio/*.mp3`)을 프로젝트에 포함  
       - LLM/Python이 반환하는 `genre`/`title`을 **내부 매핑 테이블**로 실제 파일 경로에 연결  
       - HTML5 `<audio>` 또는 Web Audio API로 재생 (강의실 PC 스피커 출력)  
       - 장점: 네트워크/인증 의존도가 낮고, 데모/발표에 안정적  
       - 단점: 음원 수가 한정되고, 상용 서비스 느낌은 덜함
    2. **V2-M2 (Spotify/YouTube Music 등 스트리밍 API 연동 – 이상적인 최종형)**  
       - LLM이 선택한 `genre`/`mood`를 **Spotify/YouTube Music 검색 쿼리**로 변환  
       - 해당 서비스의 Web Playback/Embed API를 사용하여 브라우저에서 실제 스트리밍  
       - 필요 사항:
         - 각 서비스별 OAuth 인증 플로우 (사용자 로그인 또는 데모용 토큰)
         - API Rate Limit / 재생 권한(프리뷰 vs 풀트랙)에 대한 제약 검토
         - “이 프로젝트에서 보여주고 싶은 경험”에 맞는 최소 API 사용 범위 정의  
       - 장점: 실제 상용 서비스와 유사한 경험, 곡 풀 확장성  
       - 단점: 구현 복잡도↑, 네트워크/계정/정책 이슈 존재

> 정리: **V2에서는 먼저 V2-M1(로컬 음원 매핑)을 구현하여 “진짜 소리가 나는 데모”를 확보**하고,  
> 이후 시간과 여건이 허락하면 V2-M2(Spotify/YouTube Music 연동)를 선택적으로 추가한다.

---

## 🔍 현재 상태 분석

### ✅ 이미 구현된 기능 (V1 준비 완료)

1. **어드민 로그인 및 목업 모드 감지**
   - `checkMockMode()` 함수로 어드민 계정 감지
   - DB의 `User.isAdmin` 필드 또는 이메일 기반 확인

2. **설문 완료 및 가중치 업데이트**
   - 목업 모드에서 실제 로직 실행 (메모리 저장소 사용)
   - `mockPreferenceStore.ts`로 메모리 기반 가중치 관리

3. **홈화면 초기 1세그먼트 디폴트**
   - `useColdStart.ts`에서 초기 세그먼트 생성
   - API 호출 실패 시 목업 데이터 사용

4. **전처리 및 LLM 호출**
   - `/api/preprocessing`에서 목업 데이터 반환
   - `/api/ai/background-params`에서 목업 데이터로 LLM 호출
   - Python 서버 연동 (시계열+마르코프)

5. **무드 대시보드 및 디바이스 카드**
   - 홈화면에 무드 대시보드 표시
   - 디바이스 카드 표시

6. **하트 클릭 및 별표 저장**
   - 하트 클릭 시 가중치 +1 (메모리 저장소)
   - 별표 클릭 시 무드 저장 (localStorage)

7. **세그먼트/스트림 교체**
   - `useStreamTransition`으로 스트림 전환
   - 세그먼트 교체 기능

### ⚠️ 추가 구현 필요 (V1 완성)

1. **마이페이지 어드민 모드 표시**
   - 현재: 어드민 모드 감지는 되지만 UI에 표시되지 않음
   - 필요: 마이페이지에 "관리자 모드" 표시

2. **무드 페이지 목업 무드셋 표시**
   - 현재: 목업 모드에서 localStorage 사용
   - 필요: 목업 무드셋이 제대로 표시되는지 확인

3. **전처리 → 시계열+마르코프 → LLM 플로우 검증**
   - 현재: 코드는 구현되어 있으나 전체 플로우 검증 필요
   - 필요: 어드민 모드에서 전체 플로우가 자연스럽게 동작하는지 확인

---

## 🚀 V1 개발 계획

### Phase 1: 마이페이지 어드민 모드 표시 (1-2시간)

**작업 내용**:
1. `ProfileSection.tsx`에 어드민 모드 표시 추가
   - 세션에서 `isAdmin` 확인
   - "관리자 모드" 배지 또는 텍스트 표시

**파일 수정**:
- `Web/src/app/(main)/mypage/components/ProfileSection.tsx`
- `Web/src/app/(main)/mypage/hooks/useProfile.ts` (필요 시)

**검증 방법**:
- 어드민 계정으로 로그인 → 마이페이지 접속 → "관리자 모드" 표시 확인

---

### Phase 2: 무드 페이지 목업 무드셋 표시 확인 및 개선 (2-3시간)

**작업 내용**:
1. 무드 페이지에서 목업 모드일 때 localStorage 무드셋 표시 확인
2. 목업 무드셋이 제대로 표시되지 않으면 개선
3. 무드셋 더블클릭 시 적용 기능 확인

**파일 확인/수정**:
- `Web/src/app/(main)/mood/page.tsx`
- `Web/src/lib/mock/savedMoodsStorage.ts`

**검증 방법**:
- 어드민 계정으로 로그인 → 홈화면에서 별표 클릭 → 무드 페이지 접속 → 저장된 무드 확인

---

### Phase 3: 전체 플로우 검증 및 버그 수정 (3-4시간)

**작업 내용**:
1. 어드민 로그인 → 설문 → 홈화면 플로우 검증
2. 홈화면 진입 시 초기 1세그먼트 생성 확인
3. 전처리 → 시계열+마르코프 → LLM 호출 플로우 검증
4. 무드 대시보드 및 디바이스 카드 표시 확인
5. 하트 클릭 및 별표 저장 기능 확인
6. 세그먼트/스트림 교체 기능 확인

**검증 체크리스트**:
- [ ] 어드민 로그인 성공
- [ ] 설문 완료 후 가중치 업데이트 확인 (콘솔 로그)
- [ ] 홈화면 진입 시 초기 1세그먼트 표시
- [ ] 백그라운드에서 나머지 세그먼트 생성 시작
- [ ] 전처리 API 호출 성공 (목업 데이터 반환)
- [ ] Python 서버 호출 성공 (또는 Fallback 동작)
- [ ] LLM 호출 성공 및 무드스트림 생성
- [ ] 무드 대시보드에 생성된 무드 표시
- [ ] 디바이스 카드에 무드 정보 표시
- [ ] 하트 클릭 시 가중치 업데이트 확인
- [ ] 별표 클릭 시 무드 저장 확인
- [ ] 무드 페이지에서 저장된 무드 확인
- [ ] 세그먼트 교체 기능 동작
- [ ] 스트림 교체 기능 동작

**버그 수정**:
- 발견된 버그 즉시 수정
- 에러 로그 확인 및 처리

---

### Phase 4: 배포 준비 및 문서화 (2-3시간)

**작업 내용**:
1. 환경 변수 설정 확인
2. 빌드 테스트
3. 배포 가이드 작성
4. V1 기능 문서화

**파일 생성/수정**:
- `docs/V1_DEPLOYMENT_GUIDE.md`
- `docs/V1_FEATURES.md`

---

## 🔄 V2 개발 계획 (향후)

### Phase 1: V2 코드 주석 처리 및 구조화 (4-5시간)

**작업 내용**:
1. 모든 V2 관련 코드에 `// V2:` 주석 추가
2. V1 코드와 V2 코드 명확히 구분
3. V2 코드는 주석 처리하되 구조는 유지

**주석 처리 예시**:
```typescript
// V1: 목업 모드 (메모리 저장소 사용)
if (isMockMode) {
  // 목업 로직
}

// V2: DB 저장 (배포 및 마이그레이션 후 활성화)
// if (!isMockMode) {
//   await prisma.scentPreference.upsert({ ... });
// }
```

**파일 수정 대상**:
- `Web/src/app/api/preferences/route.ts`
- `Web/src/app/api/preferences/heart/route.ts`
- `Web/src/app/api/moods/saved/route.ts`
- `Web/src/app/api/moods/saved/[savedMoodId]/route.ts`
- `Web/src/app/api/moods/saved/[savedMoodId]/apply/route.ts`
- 기타 DB 저장 관련 코드

---

### Phase 2: DB 마이그레이션 및 연결 (2-3시간)

**작업 내용**:
1. PostgreSQL 마이그레이션 실행
2. DB 연결 테스트
3. 스키마 검증

**검증 방법**:
- Prisma Studio로 데이터 확인
- API 호출 시 DB 저장 확인

---

### Phase 3: V2 코드 활성화 (3-4시간)

**작업 내용**:
1. V2 주석 처리된 코드 활성화
2. V1 목업 모드 코드는 유지 (어드민 계정용)
3. 일반 사용자는 V2 코드 사용

**활성화 예시**:
```typescript
// V1: 목업 모드 (메모리 저장소 사용)
if (isMockMode) {
  // 목업 로직
}

// V2: DB 저장 (활성화)
if (!isMockMode) {
  await prisma.scentPreference.upsert({ ... });
}
```

---

### Phase 4: 데이터 파이프라인 + 출력장치 연결 (4-6시간)

**작업 내용**:
1. Firebase → Web App 데이터 수신 확인
2. ML 서버 → Web App 감정 카운트 수신 확인
3. Python 서버 → Web App 감정 예측 수신 확인
4. 전체 파이프라인 통합 테스트
5. **실제 출력장치 연동 설계 및 코드 골격 추가**
   - Web → “조명 제어 API” 레이어 설계 (`LightControlService` 등)
   - 조명컬러 = 무드컬러 파스텔 컬러 매핑 로직 정리
   - “향 선택 시” 호출되는 Web 액션 훅/유틸 정의 (예: `useScentAction`, `triggerScentEvent`)
   - Philips Wiz 제어를 위한 **라즈베리파이 브리지 API 스펙 정의** (REST/Socket 등)
   - Web → Raspberry Pi → Wiz 전구 플로우를 V2 문서에 반영

**검증 방법**:
- 각 단계별 데이터 로그 확인
- End-to-End 테스트

---

### Phase 5: 사용자별 데이터 격리, 영구 저장, 출력장치 상태 동기화 (3-4시간)

**작업 내용**:
1. 사용자별 데이터 격리 확인
2. 영구 저장 기능 검증
3. 데이터 갱신 기능 검증
4. **출력장치 상태와 DB 상태 동기화 설계**
   - 현재 조명/향/음악 상태를 `Device`, `Preset`, `Light` 등 스키마와 연결
   - 실제 조명 상태 변경 시 DB 스냅샷 업데이트 전략 수립 (또는 주기적 동기화)

**검증 방법**:
- 여러 사용자 계정으로 테스트
- 데이터 영구 저장 확인

---

## 📝 V1 개발 우선순위

1. **높음 (즉시 구현 필요)**
   - 마이페이지 어드민 모드 표시
   - 전체 플로우 검증 및 버그 수정

2. **중간 (V1 완성 전 구현)**
   - 무드 페이지 목업 무드셋 표시 확인 및 개선
   - 배포 준비 및 문서화

3. **낮음 (V1 완성 후 개선)**
   - 성능 최적화
   - UI/UX 개선

---

## 📝 V2 개발 우선순위

1. **높음 (DB 연결 후 즉시 구현)**
   - V2 코드 주석 처리 및 구조화
   - DB 마이그레이션 및 연결
   - V2 코드 활성화

2. **중간 (V2 핵심 기능)**
   - 데이터 파이프라인 연결
   - 사용자별 데이터 격리 및 영구 저장

3. **낮음 (V2 완성 후 개선)**
   - 성능 최적화
   - 모니터링 및 로깅

---

## 🎯 V1 완성 기준

다음 조건을 모두 만족하면 V1 완성:

- [ ] 어드민 로그인 → 설문 → 홈화면 플로우 완벽 동작
- [ ] 홈화면 진입 시 초기 1세그먼트 디폴트 수행
- [ ] 전처리 → 시계열+마르코프 → LLM 호출 플로우 완벽 동작
- [ ] 무드 대시보드 및 디바이스 카드 표시
- [ ] 마이페이지에서 어드민 모드 확인 가능
- [ ] 무드 페이지에 목업 무드셋 표시
- [ ] 세그먼트/스트림 교체 경험 가능
- [ ] 별표 클릭 시 무드 저장 및 확인 가능
- [ ] 목업만으로 생성과 정보전달이 유기적으로 연결
- [ ] 배포 후 어드민 모드에서 자연스러운 플로우 확인 가능

---

## 🎯 V2 완성 기준

다음 조건을 모두 만족하면 V2 완성:

- [ ] V1의 모든 기능이 DB 기반으로 동작
- [ ] 사용자별 데이터 격리 및 영구 저장
- [ ] Firebase → Web App 데이터 수신
- [ ] ML 서버 → Web App 감정 카운트 수신
- [ ] Python 서버 → Web App 감정 예측 수신
- [ ] 전체 파이프라인 통합 테스트 완료
- [ ] 배포 및 마이그레이션 완료

---

## 📚 관련 문서

- `docs/COMPREHENSIVE_GUIDE.md`: 전체 시스템 가이드
- `docs/V1_DEPLOYMENT_GUIDE.md`: V1 배포 가이드 (작성 예정)
- `docs/V1_FEATURES.md`: V1 기능 문서 (작성 예정)

