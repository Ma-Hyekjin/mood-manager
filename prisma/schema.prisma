///////////////////////////////////////////////////////
// Prisma Config
///////////////////////////////////////////////////////
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

///////////////////////////////////////////////////////
// ENUM
///////////////////////////////////////////////////////

enum DeviceStatus {
  active
  inactive
}

///////////////////////////////////////////////////////
// USER
///////////////////////////////////////////////////////

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String?
  phone           String?   @unique

  // 프로필
  familyName      String?
  givenName       String?
  birthDate       DateTime?
  gender          String?
  profileImageUrl String?

  // 소셜 로그인
  provider        String?
  providerId      String?   @unique

  // 설문 여부
  hasSurvey       Boolean   @default(false)

  createdAt       DateTime  @default(now())

  // Relations
  devices         Device[]
  presets         Preset[]
  preferences     UserPreferences?
  inquiries       Inquiry[]
}

///////////////////////////////////////////////////////
// DEVICE
///////////////////////////////////////////////////////

model Device {
  id              String       @id @default(uuid())
  userId          String
  name            String
  type            String       // manager | light | scent | speaker
  status          DeviceStatus @default(active)
  registeredAt    DateTime     @default(now())

  // Device 제어용 필드
  battery         Int?
  power           Boolean?
  brightness      Int?
  color           String?
  scentType       String?
  scentLevel      Int?
  scentInterval   Int?
  volume          Int?
  nowPlaying      String?

  // Preset 적용
  currentPresetId String?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  preset Preset? @relation(fields: [currentPresetId], references: [id])
}

///////////////////////////////////////////////////////
// PRESET COMPONENTS (필수)
///////////////////////////////////////////////////////

model Fragrance {
  id             Int      @id @default(autoincrement())
  name           String
  description    String?
  intensityLevel Int
  operatingMin   Int
  componentsJson Json

  presets        Preset[]
}

model Light {
  id         Int      @id @default(autoincrement())
  name       String
  color      String
  brightness Int

  presets    Preset[]
}

model Sound {
  id      Int      @id @default(autoincrement())
  name    String
  fileUrl String

  presets Preset[]
}

///////////////////////////////////////////////////////
// PRESET (무드 정의)
///////////////////////////////////////////////////////

model Preset {
  id           String   @id @default(uuid())
  userId       String
  fragranceId  Int
  lightId      Int
  soundId      Int
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  updatedType  String?

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fragrance  Fragrance @relation(fields: [fragranceId], references: [id])
  light      Light     @relation(fields: [lightId], references: [id])
  sound      Sound     @relation(fields: [soundId], references: [id])

  devices    Device[]
}

///////////////////////////////////////////////////////
// USER SURVEY (설문)
///////////////////////////////////////////////////////

model UserPreferences {
  id                  Int      @id @default(autoincrement())
  userId              String   @unique

  fragranceTop1       String?
  fragranceTop2       String?
  fragranceTop3       String?
  preferredLightR     Int?
  preferredLightG     Int?
  preferredLightB     Int?
  preferredBrightness Float?
  soundGenreTop1      String?
  soundGenreTop2      String?
  soundGenreTop3      String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

///////////////////////////////////////////////////////
// INQUIRY (문의)
///////////////////////////////////////////////////////

model Inquiry {
  id        Int      @id @default(autoincrement())
  userId    String
  subject   String
  message   String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

///////////////////////////////////////////////////////
// PASSWORD RESET (비밀번호 재설정)
///////////////////////////////////////////////////////

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  email     String
  code      String   // 6자리 인증코드
  token     String?  @unique // 비밀번호 재설정 토큰 (인증 후 발급)
  expiresAt DateTime // 만료 시간
  used      Boolean  @default(false) // 사용 여부 (한 번만 사용 가능)
  createdAt DateTime @default(now())

  @@index([email, code])
  @@index([email, token])
}
